<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Dashboard - Book Management</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="css/style.css">
	<style>
		.stat-card {
			border-radius: 0.75rem;
			transition: transform 0.2s, box-shadow 0.2s;
		}
		.stat-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		.stat-card[data-href] {
			cursor: pointer;
		}
		.stat-icon {
			width: 48px;
			height: 48px;
			border-radius: 0.5rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.stat-number {
			font-size: 1.75rem;
			font-weight: 700;
		}
		.activity-item {
			padding: 0.75rem 0;
			border-bottom: 1px solid #e9ecef;
		}
		.activity-item:last-child {
			border-bottom: none;
		}
		.activity-icon {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
		}
		.activity-time {
			font-size: 0.75rem;
			color: #6c757d;
		}
		.overdue-alert {
			color: black;
		}
		.progress-stat {
			height: 8px;
			border-radius: 4px;
		}
		
		/* Activities Panel - Slide from right */
		.activities-panel {
			position: fixed;
			top: var(--navbar-height);
			right: 0;
			bottom: 0;
			width: 380px;
			background: white;
			box-shadow: -2px 0 10px rgba(0,0,0,0.1);
			transform: translateX(100%);
			transition: transform 0.3s ease;
			z-index: 1045;
			overflow-y: auto;
		}
		
		.activities-panel.show {
			transform: translateX(0);
		}
		
		.activities-backdrop {
			position: fixed;
			inset: var(--navbar-height) 0 0 0;
			background: rgba(0,0,0,0.3);
			z-index: 1044;
			display: none;
		}
		
		.activities-backdrop.show {
			display: block;
		}
		
		.activities-toggle-btn {
			position: fixed;
			top: calc(var(--navbar-height) + 1rem);
			right: 1rem;
			z-index: 1046;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
		}
		
		@media (max-width: 768px) {
			.activities-panel {
				width: 90%;
				max-width: 380px;
			}
		}
	</style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
	<div id="navbarInclude" data-include="../include/navbar.html"></div>
	<div class="layout-wrapper">
		<div id="sidebarInclude" data-include="../include/sidebar.html"></div>
		<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
		<main class="content-area">
			<div class="container-fluid py-4">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h1 class="text-primary mb-0" style="font-size: 25px;">Dashboard</h1>
					<button class="btn btn-primary activities-toggle-btn" id="toggleActivitiesPanel">
						<!-- <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
						</svg> -->
						Activities
					</button>
				</div>

				<div class="row">
					<!-- Full Width - Statistics -->
					<div class="col-12">
						<!-- Overdue Alert -->
						<div id="overdueAlert" class="card stat-card overdue-alert mb-4 d-none">
							<div class="card-body d-flex align-items-center">
								<div class="stat-icon bg-white bg-opacity-25 me-3">
									<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
										<path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
									</svg>
								</div>
								<div class="flex-grow-1">
									<h5 class="mb-1">Overdue Warning!</h5>
									<p class="mb-0">There are <strong id="overdueCount">0</strong> overdue book rentals that need attention.</p>
								</div>
								<a href="index-rental.html?status=overdue" class="btn btn-light btn-sm">View Details</a>
							</div>
						</div>

						<!-- Rental Status Stats -->
						<div class="card border-0 shadow-sm mb-4">
							<div class="card-header bg-white border-0">
								<h5 class="mb-0">Book Rental Statistics</h5>
							</div>
							<div class="card-body">
								<div class="row g-4">
									<!-- Active Rentals -->
									<div class="col-md-4">
										<div class="d-flex align-items-center mb-2">
											<span class="badge bg-success me-2">Active</span>
											<span class="text-muted small">Renting</span>
										</div>
										<div class="d-flex align-items-baseline">
											<span class="h3 mb-0 me-2" id="activeRentals">-</span>
											<span class="text-muted small">/ <span id="totalRentalsForActive">-</span> rentals</span>
										</div>
										<div class="progress progress-stat mt-2">
											<div class="progress-bar bg-success" id="activeProgress" style="width: 0%"></div>
										</div>
									</div>

									<!-- Overdue Rentals -->
									<div class="col-md-4">
										<div class="d-flex align-items-center mb-2">
											<span class="badge bg-danger me-2">Overdue</span>
											<span class="text-muted small">Overdue</span>
										</div>
										<div class="d-flex align-items-baseline">
											<span class="h3 mb-0 me-2" id="overdueRentals">-</span>
											<span class="text-muted small">/ <span id="totalRentalsForOverdue">-</span> rentals</span>
										</div>
										<div class="progress progress-stat mt-2">
											<div class="progress-bar bg-danger" id="overdueProgress" style="width: 0%"></div>
										</div>
									</div>

									<!-- Returned Rentals -->
									<div class="col-md-4">
										<div class="d-flex align-items-center mb-2">
											<span class="badge bg-secondary me-2">Returned</span>
											<span class="text-muted small">Returned</span>
										</div>
										<div class="d-flex align-items-baseline">
											<span class="h3 mb-0 me-2" id="returnedRentals">-</span>
											<span class="text-muted small">/ <span id="totalRentalsForReturned">-</span> rentals</span>
										</div>
										<div class="progress progress-stat mt-2">
											<div class="progress-bar bg-secondary" id="returnedProgress" style="width: 0%"></div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- Main Stats Row -->
						<div class="row g-3 mb-4">
							<!-- Total Books -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Total Books</div>
												<div class="stat-number text-primary" id="totalBooks">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Total Categories -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index-genre.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-success bg-opacity-10 text-success me-3">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Genres</div>
												<div class="stat-number text-success" id="totalCategories">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Total Authors -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index-author.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-purple bg-opacity-10 text-purple me-3" style="background-color: rgba(111, 66, 193, 0.1); color: #6f42c1;">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0Zm-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/>
													<path d="M8.256 14a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Authors</div>
												<div class="stat-number" style="color: #6f42c1;" id="totalAuthors">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Total Publishers -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index-publisher.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-opacity-10 me-3" style="background-color: rgba(253, 126, 20, 0.1); color: #fd7e14;">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M1 2a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v1h.5A1.5 1.5 0 0 1 16 4.5v7a1.5 1.5 0 0 1-1.5 1.5h-.55a2.5 2.5 0 0 1-2.45 2h-8A2.5 2.5 0 0 1 1 12.5V2Zm13 10h.5a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.5-.5H14v8ZM2 2v10.5A1.5 1.5 0 0 0 3.5 14h8a1.5 1.5 0 0 0 1.5-1.5V2H2Z"/>
													<path d="M3 3h9v2H3V3Zm0 3h9v1H3V6Zm0 2h6v1H3V8Z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Publishers</div>
												<div class="stat-number" style="color: #fd7e14;" id="totalPublishers">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Total Users -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index-user.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-info bg-opacity-10 text-info me-3">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Users</div>
												<div class="stat-number text-info" id="totalUsers">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Total Rentals -->
							<div class="col-sm-6 col-xl-4">
								<div class="card stat-card h-100 border-0 shadow-sm" data-href="index-rental.html">
									<div class="card-body">
										<div class="d-flex align-items-center">
											<div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
													<path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
													<path d="M4.5 12.5A.5.5 0 0 1 5 12h3a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0-2A.5.5 0 0 1 5 10h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm1.639-3.708 1.33.886 1.854-1.855a.25.25 0 0 1 .289-.047l1.888.974V8.5a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V8s1.54-1.274 1.639-1.208zM6.25 6a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5z"/>
												</svg>
											</div>
											<div>
												<div class="text-muted small">Rentals</div>
												<div class="stat-number text-warning" id="totalRentals">-</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						
						<!-- Book Stats -->
						<div class="card border-0 shadow-sm">
							<div class="card-header bg-white border-0">
								<h5 class="mb-0">Book Statistics</h5>
							</div>
							<div class="card-body">
								<div class="row g-4">
									<div class="col-md-4">
										<div class="text-muted small mb-1">Being Rented</div>
										<div class="h4 mb-0 text-warning" id="rentalBooks">-</div>
									</div>
									<div class="col-md-4">
										<div class="text-muted small mb-1">In Stock</div>
										<div class="h4 mb-0 text-success" id="saleBooks">-</div>
									</div>
									<div class="col-md-4">
										<div class="text-muted small mb-1">Total Stock</div>
										<div class="h4 mb-0 text-primary" id="totalStock">-</div>
									</div>
								</div>
							</div>
						</div>

						<!-- Top Most Rented Books -->
						<div class="card border-0 shadow-sm mt-4">
							<div class="card-header bg-white border-0">
								<h5 class="mb-0">Top Most Rented Books</h5>
							</div>
							<div class="card-body p-0">
								<div class="table-responsive">
									<table class="table table-hover mb-0">
										<thead class="table-light">
											<tr>
												<th class="text-center" style="width: 50px;">#</th>
												<th>Book Title</th>
												<th>Author</th>
												<th class="text-center">Times Rented</th>
												<th class="text-center">Currently Renting</th>
											</tr>
										</thead>
										<tbody id="topBooksTable">
											<tr>
												<td colspan="5" class="text-center text-muted py-4">
													<div class="spinner-border spinner-border-sm me-2"></div>
													Loading...
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>
	
	<!-- Activities Panel (Slide from right) -->
	<div class="activities-backdrop" id="activitiesBackdrop"></div>
	<div class="activities-panel" id="activitiesPanel">
		<div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center sticky-top">
			<h5 class="mb-0">Recent Activities</h5>
			<div class="d-flex gap-2">
				<button class="btn btn-sm btn-outline-primary" id="refreshActivities" title="Refresh">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
						<path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
						<path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
					</svg>
				</button>
				<button class="btn btn-sm btn-outline-secondary" id="closeActivitiesPanel" title="Close">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
						<path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
					</svg>
				</button>
			</div>
		</div>
		<div id="activitiesList" class="p-3">
			<div class="text-center text-muted py-4">
				<div class="spinner-border spinner-border-sm me-2"></div>
				Loading...
			</div>
		</div>
	</div>
	
	<div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="js/auth-check.js"></script>
	<script src="js/layout.js"></script>
	<script>
		document.querySelectorAll('[data-include]').forEach((node) => {
			fetch(node.dataset.include)
				.then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
				.then((html) => {
					node.innerHTML = html;
					node.querySelectorAll('script').forEach((oldScript) => {
						const newScript = document.createElement('script');
						if (oldScript.src) newScript.src = oldScript.src;
						else newScript.textContent = oldScript.textContent;
						oldScript.parentNode.replaceChild(newScript, oldScript);
					});
					window.initLayout?.();
				})
				.catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
		});
	</script>
	<script>
		(() => {
			const escapeHtml = (text) => {
				if (text === null || text === undefined) return '';
				const div = document.createElement('div');
				div.textContent = String(text);
				return div.innerHTML;
			};

			const formatDate = (dateStr) => {
				if (!dateStr) return '-';
				const d = new Date(dateStr);
				return d.toLocaleString('vi-VN', {
					year: 'numeric',
					month: '2-digit',
					day: '2-digit',
					hour: '2-digit',
					minute: '2-digit',
					timeZone: 'Asia/Ho_Chi_Minh'
				});
			};

			const formatTimeAgo = (dateStr) => {
				if (!dateStr) return '';
				const d = new Date(dateStr);
				const now = new Date();
				const diffMs = now - d;
				const diffMins = Math.floor(diffMs / 60000);
				const diffHours = Math.floor(diffMs / 3600000);
				const diffDays = Math.floor(diffMs / 86400000);

				if (diffMins < 1) return 'Just now';
				if (diffMins < 60) return `${diffMins} minutes ago`;
				if (diffHours < 24) return `${diffHours} hours ago`;
				if (diffDays < 7) return `${diffDays} days ago`;
				return formatDate(dateStr);
			};

			// Counter animation function
			const animateCounter = (element, target, duration = 1000) => {
				if (!element) return;
				const start = 0;
				const increment = target / (duration / 16); // 60fps
				let current = start;
				
				const timer = setInterval(() => {
					current += increment;
					if (current >= target) {
						element.textContent = Math.round(target);
						clearInterval(timer);
					} else {
						element.textContent = Math.round(current);
					}
				}, 16);
			};

			// Animate progress bar
			const animateProgressBar = (element, targetWidth, duration = 1000) => {
				if (!element) return;
				let currentWidth = 0;
				const increment = targetWidth / (duration / 16);
				
				const timer = setInterval(() => {
					currentWidth += increment;
					if (currentWidth >= targetWidth) {
						element.style.width = `${targetWidth}%`;
						clearInterval(timer);
					} else {
						element.style.width = `${currentWidth}%`;
					}
				}, 16);
			};

			// Lấy danh sách ID sách bị ẩn từ localStorage (giống Book Management)
			const HIDDEN_KEY = 'book_hidden_ids';
			const getHiddenIds = () => {
				try {
					return new Set(JSON.parse(localStorage.getItem(HIDDEN_KEY) || '[]').map(String));
				} catch {
					return new Set();
				}
			};

			// Load Statistics
			const loadStats = async () => {
				try {
					// Load books stats from api/db.php (bảng books)
					let totalBooks = 0, totalStock = 0;
					try {
						const booksRes = await fetch('api/db.php?limit=10000');
						if (booksRes.ok) {
							const booksData = await booksRes.json();
							let books = [];
							if (booksData.success && booksData.data) {
								books = booksData.data;
							} else if (Array.isArray(booksData)) {
								books = booksData;
							} else if (booksData.data && Array.isArray(booksData.data)) {
								books = booksData.data;
							}
							
							const hiddenIds = getHiddenIds();
							const filteredBooks = books.filter(b => !hiddenIds.has(String(b.id ?? '')));
							
							totalBooks = filteredBooks.length;
							totalStock = filteredBooks.reduce((sum, b) => sum + (parseInt(b.stock) || 0), 0);
						}
					} catch (e) { console.error('Books API error:', e); }
					
					animateCounter(document.getElementById('totalBooks'), totalBooks);
					animateCounter(document.getElementById('totalStock'), totalStock);

					// Load genres stats
					let totalCategories = 0;
					try {
						const genresRes = await fetch('api/genres.php?per_page=10000');
						if (genresRes.ok) {
							const genresData = await genresRes.json();
							let genres = [];
							if (Array.isArray(genresData)) {
								genres = genresData;
							} else if (genresData.data && Array.isArray(genresData.data)) {
								genres = genresData.data;
							}
							totalCategories = genres.filter(g => !g.deleted_at).length;
						}
					} catch (e) { console.error('Genres API error:', e); }
					animateCounter(document.getElementById('totalCategories'), totalCategories);

					// Load authors stats
					let totalAuthors = 0;
					try {
						const authorsRes = await fetch('api/authors.php?per_page=10000');
						if (authorsRes.ok) {
							const authorsData = await authorsRes.json();
							let authors = [];
							if (Array.isArray(authorsData)) {
								authors = authorsData;
							} else if (authorsData.data && Array.isArray(authorsData.data)) {
								authors = authorsData.data;
							}
							totalAuthors = authors.filter(a => !a.deleted_at).length;
						}
					} catch (e) { console.error('Authors API error:', e); }
					animateCounter(document.getElementById('totalAuthors'), totalAuthors);

					// Load publishers stats
					let totalPublishers = 0;
					try {
						const publishersRes = await fetch('api/publishers.php?per_page=10000');
						if (publishersRes.ok) {
							const publishersData = await publishersRes.json();
							let publishers = [];
							if (Array.isArray(publishersData)) {
								publishers = publishersData;
							} else if (publishersData.data && Array.isArray(publishersData.data)) {
								publishers = publishersData.data;
							}
							totalPublishers = publishers.filter(p => !p.deleted_at).length;
						}
					} catch (e) { console.error('Publishers API error:', e); }
					animateCounter(document.getElementById('totalPublishers'), totalPublishers);

					// Load users stats
					let totalUsers = 0;
					try {
						const usersRes = await fetch('api/users.php?per_page=10000');
						if (usersRes.ok) {
							const usersData = await usersRes.json();
							let users = [];
							if (Array.isArray(usersData)) {
								users = usersData;
							} else if (usersData.data && Array.isArray(usersData.data)) {
								users = usersData.data;
							}
							totalUsers = users.filter(u => !u.deleted_at).length;
						}
					} catch (e) { console.error('Users API error:', e); }
					animateCounter(document.getElementById('totalUsers'), totalUsers);

					// Load rentals stats
					let totalRentals = 0, activeRentals = 0, overdueRentals = 0, returnedRentals = 0;
					let booksBeingRented = 0;
					try {
						const rentalsRes = await fetch('api/rentals.php?per_page=10000');
						if (rentalsRes.ok) {
							const rentalsData = await rentalsRes.json();
							let rentals = [];
							if (Array.isArray(rentalsData)) {
								rentals = rentalsData;
							} else if (rentalsData.data && Array.isArray(rentalsData.data)) {
								rentals = rentalsData.data;
							}
							const filteredRentals = rentals.filter(r => !r.deleted_at);
							totalRentals = filteredRentals.length;
							activeRentals = filteredRentals.filter(r => r.status === 'active').length;
							overdueRentals = filteredRentals.filter(r => r.status === 'overdue').length;
							returnedRentals = filteredRentals.filter(r => r.status === 'returned').length;
							
							filteredRentals.forEach(r => {
								if (r.status === 'active' || r.status === 'overdue') {
									if (Array.isArray(r.items)) {
										r.items.forEach(item => {
											booksBeingRented += parseInt(item.quantity) || 1;
										});
									} else {
										booksBeingRented += 1;
									}
								}
							});
						}
					} catch (e) { console.error('Rentals API error:', e); }

					animateCounter(document.getElementById('totalRentals'), totalRentals);
					animateCounter(document.getElementById('activeRentals'), activeRentals);
					animateCounter(document.getElementById('overdueRentals'), overdueRentals);
					animateCounter(document.getElementById('returnedRentals'), returnedRentals);
					
					animateCounter(document.getElementById('rentalBooks'), booksBeingRented);
					animateCounter(document.getElementById('saleBooks'), Math.max(0, totalStock - booksBeingRented));

					document.getElementById('totalRentalsForActive').textContent = totalRentals;
					document.getElementById('totalRentalsForOverdue').textContent = totalRentals;
					document.getElementById('totalRentalsForReturned').textContent = totalRentals;

					// Animate progress bars
					if (totalRentals > 0) {
						animateProgressBar(document.getElementById('activeProgress'), (activeRentals / totalRentals) * 100);
						animateProgressBar(document.getElementById('overdueProgress'), (overdueRentals / totalRentals) * 100);
						animateProgressBar(document.getElementById('returnedProgress'), (returnedRentals / totalRentals) * 100);
					} else {
						document.getElementById('activeProgress').style.width = '0%';
						document.getElementById('overdueProgress').style.width = '0%';
						document.getElementById('returnedProgress').style.width = '0%';
					}

					// Show overdue alert if there are overdue rentals
					const overdueAlert = document.getElementById('overdueAlert');
					if (overdueRentals > 0) {
						document.getElementById('overdueCount').textContent = overdueRentals;
						overdueAlert.classList.remove('d-none');
					} else {
						overdueAlert.classList.add('d-none');
					}

				} catch (error) {
					console.error('Error loading stats:', error);
				}
			};

			// Load Top Most Rented Books
			const loadTopRentedBooks = async () => {
				const topBooksTable = document.getElementById('topBooksTable');
				
				try {
					// 1. Fetch all rentals để đếm số lần thuê
					const rentalsRes = await fetch('api/rentals.php?per_page=10000');
					if (!rentalsRes.ok) throw new Error('Failed to fetch rentals');
					
					const rentalsData = await rentalsRes.json();
					let rentals = [];
					if (Array.isArray(rentalsData)) {
						rentals = rentalsData;
					} else if (rentalsData.data && Array.isArray(rentalsData.data)) {
						rentals = rentalsData.data;
					}
					const filteredRentals = rentals.filter(r => !r.deleted_at);

					// 2. Đếm số lần thuê và lưu thông tin sách
					const bookRentalCount = {}; // { book_id: số_lần_thuê }
					const bookIds = new Set(); // Lưu tất cả book_id để fetch sau
					
					filteredRentals.forEach(rental => {
						if (Array.isArray(rental.items)) {
							rental.items.forEach(item => {
								const bookId = item.book_id;
								if (!bookId) return;
								
								// Đếm mỗi lần xuất hiện trong rental.items = 1 lần thuê
								bookRentalCount[bookId] = (bookRentalCount[bookId] || 0) + 1;
								bookIds.add(bookId);
							});
						}
					});

					// 3. Fetch thông tin chi tiết của từng sách để lấy author chính xác
					const booksInfo = {};
					await Promise.all(
						Array.from(bookIds).map(async (bookId) => {
							try {
								const bookRes = await fetch(`api/books.php?id=${encodeURIComponent(bookId)}`);
								if (bookRes.ok) {
									const bookData = await bookRes.json();
									const book = bookData?.data ?? bookData;
									if (book) {
										booksInfo[bookId] = {
											title: book.title || 'Unknown',
											author: book.author || 'Unknown', // Author từ books table
											currentlyRenting: 0
										};
									}
								}
							} catch (e) {
								console.warn(`Failed to fetch book ${bookId}:`, e);
							}
						})
					);

					// 4. Đếm số sách đang được thuê hiện tại (active + overdue)
					filteredRentals.forEach(rental => {
						if (rental.status === 'active' || rental.status === 'overdue') {
							if (Array.isArray(rental.items)) {
								rental.items.forEach(item => {
									const bookId = item.book_id;
									if (bookId && booksInfo[bookId]) {
										booksInfo[bookId].currentlyRenting += parseInt(item.quantity) || 1;
									}
								});
							}
						}
					});

					// 5. Chuyển sang array và sắp xếp theo số lần thuê (giảm dần)
					const topBooks = Object.entries(bookRentalCount)
						.map(([bookId, count]) => ({
							bookId,
							count, // Tổng số lần thuê
							...(booksInfo[bookId] || { title: 'Unknown', author: 'Unknown', currentlyRenting: 0 })
						}))
						.sort((a, b) => b.count - a.count) // Sắp xếp giảm dần theo số lần thuê
						.slice(0, 10); // Lấy top 10

					if (topBooks.length === 0) {
						topBooksTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No rental data available.</td></tr>';
						return;
					}

					// 6. Render bảng
					topBooksTable.innerHTML = topBooks.map((book, index) => {
						// Badge color theo ranking
						const badgeClass = index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : index === 2 ? 'bg-info' : 'bg-light text-dark';
						
						// Badge cho số sách đang thuê
						const rentingBadge = book.currentlyRenting > 0 
							? `<span class="badge bg-success">${book.currentlyRenting}</span>` 
							: '<span class="text-muted">-</span>';
						
						return `
							<tr style="cursor: pointer;" data-book-id="${book.bookId}" title="Click to view book details">
								<td class="text-center">
									<span class="badge ${badgeClass}">${index + 1}</span>
								</td>
								<td>
									<div class="fw-semibold">${escapeHtml(book.title)}</div>
								</td>
								<td>${escapeHtml(book.author)}</td>
								<td class="text-center">
									<span class="badge bg-primary">${book.count}</span>
								</td>
								<td class="text-center">${rentingBadge}</td>
							</tr>
						`;
					}).join('');

					// Thêm event listener cho click vào row
					topBooksTable.querySelectorAll('tr[data-book-id]').forEach(row => {
						row.addEventListener('click', (e) => {
							const bookId = row.dataset.bookId;
							if (bookId) {
								window.location.href = `details.html?id=${encodeURIComponent(bookId)}`;
							}
						});
					});

				} catch (error) {
					console.error('Error loading top rented books:', error);
					topBooksTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading data.</td></tr>';
				}
			};

			// Load Recent Activities
			const loadActivities = async () => {
				const activitiesList = document.getElementById('activitiesList');
				
				try {
					const rentalsRes = await fetch('api/rentals.php?per_page=50');
					if (!rentalsRes.ok) throw new Error('Failed to fetch rentals');
					
					const rentalsData = await rentalsRes.json();
					let rentals = [];
					if (Array.isArray(rentalsData)) {
						rentals = rentalsData;
					} else if (rentalsData.data && Array.isArray(rentalsData.data)) {
						rentals = rentalsData.data;
					}
					const filteredRentals = rentals.filter(r => !r.deleted_at);

					if (filteredRentals.length === 0) {
						activitiesList.innerHTML = '<div class="text-center text-muted py-4">No activities yet.</div>';
						return;
					}

					const activities = [];

					filteredRentals.forEach(rental => {
						if (rental.rental_date) {
							activities.push({
								type: 'rental_created',
								date: rental.rental_date,
								rental: rental
							});
						}
						if (rental.status === 'returned' && rental.return_date) {
							activities.push({
								type: 'rental_returned',
							 date: rental.return_date,
								rental: rental
							});
						}
						if (rental.status === 'overdue') {
							activities.push({
								type: 'rental_overdue',
								date: rental.due_date,
								rental: rental
							});
						}
					});

					activities.sort((a, b) => new Date(b.date) - new Date(a.date));
					const recentActivities = activities.slice(0, 15);

					if (recentActivities.length === 0) {
						activitiesList.innerHTML = '<div class="text-center text-muted py-4">No activities yet.</div>';
						return;
					}

					const getActivityIcon = (type) => {
						switch (type) {
							case 'rental_created':
								return { bg: 'bg-success', color: 'success', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>' };
							case 'rental_returned':
								return { bg: 'bg-secondary', color: 'secondary', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.854 8.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/></svg>' };
							case 'rental_overdue':
								return { bg: 'bg-danger', color: 'danger', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>' };
							default:
								return { bg: 'bg-primary', color: 'primary', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 0 1 0 8 0a8 8 0 0 0 0 16z"/></svg>' };
						}
					};

					const getActivityText = (activity) => {
						const userName = escapeHtml(activity.rental.user_name || 'Unknown');
						const bookTitles = escapeHtml(activity.rental.book_titles || 'Unknown');
						
						switch (activity.type) {
							case 'rental_created':
								return `<strong>${userName}</strong> rented book <em>${bookTitles}</em>`;
							case 'rental_returned':
								return `<strong>${userName}</strong> returned book <em>${bookTitles}</em>`;
							case 'rental_overdue':
								return `<strong>${userName}</strong>'s rental is overdue (<em>${bookTitles}</em>)`;
							default:
								return 'Unknown activity';
						}
					};

					activitiesList.innerHTML = recentActivities.map(activity => {
						const iconData = getActivityIcon(activity.type);
						return `
							<div class="activity-item d-flex align-items-start">
								<div class="activity-icon ${iconData.bg} bg-opacity-10 text-${iconData.color} me-3">
									${iconData.icon}
								</div>
								<div class="flex-grow-1">
									<div class="small">${getActivityText(activity)}</div>
									<div class="activity-time">${formatTimeAgo(activity.date)}</div>
								</div>
							</div>
						`;
					}).join('');

				} catch (error) {
					console.error('Error loading activities:', error);
					activitiesList.innerHTML = '<div class="text-center text-danger py-4">Error loading activities.</div>';
				}
			};

			// Toggle Activities Panel
			const toggleBtn = document.getElementById('toggleActivitiesPanel');
			const closeBtn = document.getElementById('closeActivitiesPanel');
			const activitiesPanel = document.getElementById('activitiesPanel');
			const activitiesBackdrop = document.getElementById('activitiesBackdrop');
			
			const openActivitiesPanel = () => {
				activitiesPanel.classList.add('show');
				activitiesBackdrop.classList.add('show');
				document.body.style.overflow = 'hidden';
			};
			
			const closeActivitiesPanel = () => {
				activitiesPanel.classList.remove('show');
				activitiesBackdrop.classList.remove('show');
				document.body.style.overflow = '';
			};
			
			toggleBtn.addEventListener('click', () => {
				if (activitiesPanel.classList.contains('show')) {
					closeActivitiesPanel();
				} else {
					openActivitiesPanel();
				}
			});
			
			closeBtn.addEventListener('click', closeActivitiesPanel);
			activitiesBackdrop.addEventListener('click', closeActivitiesPanel);

			// Refresh button
			document.getElementById('refreshActivities').addEventListener('click', () => {
				const activitiesList = document.getElementById('activitiesList');
				activitiesList.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2"></div>Đang tải...</div>';
				loadStats();
				loadActivities();
			});

			// Handle stat card clicks - navigate to corresponding page
			document.querySelectorAll('.stat-card[data-href]').forEach(card => {
				card.addEventListener('click', (e) => {
					const href = card.dataset.href;
					if (href) {
						window.location.href = href;
					}
				});
			});

			// Initial load
			loadStats();
			loadActivities();
			loadTopRentedBooks();

			// Auto refresh every 30 seconds
			setInterval(() => {
				loadStats();
				loadActivities();
				loadTopRentedBooks();
			}, 30000);
		})();
	</script>
</body>
</html>
