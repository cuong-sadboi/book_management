// Helper function to get current datetime in Vietnam timezone for datetime-local input
const getVietnamDateTimeLocal = (addDays = 0) => {
	const now = new Date();
	// Use Intl.DateTimeFormat to get Vietnam timezone parts
	const vnOptions = { 
		timeZone: 'Asia/Ho_Chi_Minh', 
		year: 'numeric', 
		month: '2-digit', 
		day: '2-digit', 
		hour: '2-digit', 
		minute: '2-digit',
		hour12: false 
	};
	const parts = new Intl.DateTimeFormat('en-CA', vnOptions).formatToParts(now);
	
	let year = '', month = '', day = '', hour = '', minute = '';
	parts.forEach(p => {
		if (p.type === 'year') year = p.value;
		if (p.type === 'month') month = p.value;
		if (p.type === 'day') day = p.value;
		if (p.type === 'hour') hour = p.value;
		if (p.type === 'minute') minute = p.value;
	});
	
	// Create date object and add days
	let vnDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
	if (addDays > 0) {
		vnDate.setDate(vnDate.getDate() + addDays);
	}
	
	const y = vnDate.getFullYear();
	const m = String(vnDate.getMonth() + 1).padStart(2, '0');
	const d = String(vnDate.getDate()).padStart(2, '0');
	const h = String(vnDate.getHours()).padStart(2, '0');
	const min = String(vnDate.getMinutes()).padStart(2, '0');
	
	return `${y}-${m}-${d}T${h}:${min}`;
};

// Set default due date (14 days from now in Vietnam timezone)
document.getElementById('dueDate').value = getVietnamDateTimeLocal(14);

// Add this constant at the beginning of the IIFE
const MAX_BOOKS = 5; // Maximum number of books allowed

// Add this new function after populateBookSelects
const updateAddBookButton = () => {
	const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
	if (currentCount >= MAX_BOOKS) {
		btnAddBook.disabled = true;
		btnAddBook.textContent = `Maximum ${MAX_BOOKS} books reached`;
		btnAddBook.classList.add('btn-secondary');
		btnAddBook.classList.remove('btn-outline-secondary');
	} else {
		btnAddBook.disabled = false;
		btnAddBook.textContent = '+ Add Book';
		btnAddBook.classList.remove('btn-secondary');
		btnAddBook.classList.add('btn-outline-secondary');
	}
};

// Update the updateRemoveButtons function to also call updateAddBookButton
const updateRemoveButtons = () => {
	const items = bookItemsContainer.querySelectorAll('.book-item');
	items.forEach((item, idx) => {
		const btn = item.querySelector('.btn-remove-book');
		btn.disabled = items.length <= 1;
	});
	updateAddBookButton(); // Also update add button state
};

// Update the btnAddBook click handler to check limit
btnAddBook.addEventListener('click', () => {
	const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
	if (currentCount >= MAX_BOOKS) {
		alert(`You can only add up to ${MAX_BOOKS} books per rental.`);
		return;
	}
	
	// ...existing code to create new item...
});

// Call updateRemoveButtons at the end to initialize button states
updateRemoveButtons();
