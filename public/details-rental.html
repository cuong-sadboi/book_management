<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Chi tiết Thuê sách | Book Rental Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
  <div id="navbarInclude" data-include="../include/navbar.html"></div>
  <div class="layout-wrapper">
    <div id="sidebarInclude" data-include="../include/sidebar.html"></div>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    <main class="content-area">
      <div class="container">
        <div id="detailsCard" class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
            <h2 class="h4 mb-0">RENTAL INFORMATION</h2>
            <a class="btn btn-outline-secondary" href="index-rental.html">Back</a>
          </div>
          <div class="card-body" id="detailsBody">
            <div class="text-center text-muted py-5">Load data...</div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="js/layout.js"></script>
  <script>
    document.querySelectorAll('[data-include]').forEach((node) => {
      fetch(node.dataset.include)
        .then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
        .then((html) => {
          node.innerHTML = html;
          window.initLayout?.();
        })
        .catch(() => {
          node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>';
        });
    });
  </script>
  <script>
    (() => {
      const detailsBody = document.getElementById('detailsBody');
      const params = new URLSearchParams(window.location.search);
      const rentalId = params.get('id');

      if (!rentalId) {
        detailsBody.innerHTML = '<div class="alert alert-warning mb-0">Thiếu mã thuê sách.</div>';
        return;
      }

      const escapeHtml = (text) => {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      };

      // Placeholder shared constant
      const COVER_PLACEHOLDER = 'https://via.placeholder.com/80x110?text=No+Cover';
      // helper to safely place data-attrs into HTML
      const escapeAttr = (s) => String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
 
      const normalizeUrl = (u) => {
         // remove duplicate slashes after protocol
         return String(u).replace(/([^:]\/)\/+/g, '$1');
       };
 
       // Resolve candidate URLs for cover image (robust variants)
       const getCoverCandidates = (cover) => {
        const p = window.location.pathname || '';
        const idx = p.indexOf('/public/');
        const baseRoot = idx !== -1 ? p.substring(0, idx) : '';
        const origin = window.location.origin;
        const rootPrefix = origin + baseRoot;
        if (!cover) return [COVER_PLACEHOLDER];
        const s = String(cover).trim();
        const list = [];
        if (/^https?:\/\//i.test(s)) {
          list.push(s);
        } else if (s.startsWith('//')) {
          list.push(window.location.protocol + s);
        } else {
          const raw = s.replace(/^\/+/, '');
          // generic candidate patterns for common server layouts
          const patterns = [
            `${rootPrefix}/public/${raw}`,
            `${rootPrefix}/${raw}`,
            `${origin}/public/${raw}`,
            `${origin}/${raw}`,
            `${rootPrefix}/public/uploads/books/${raw}`,
            `${rootPrefix}/public/uploads/${raw}`,
            `${rootPrefix}/uploads/books/${raw}`,
            `${rootPrefix}/uploads/${raw}`,
            `${origin}/uploads/books/${raw}`,
            `${origin}/uploads/${raw}`,
            `./${raw}`,
            `../${raw}`
          ];
          patterns.forEach(u => {
            // normalize and encode each candidate
            try {
              list.push(encodeURI(normalizeUrl(u)));
            } catch (e) {
              list.push(normalizeUrl(u));
            }
          });
          // if raw is just a filename, also try static/covers and uploads/books without duplication
          if (!raw.includes('/')) {
            ['public/static/covers', 'static/covers', 'public/uploads/covers', 'uploads/covers', 'public/uploads/books', 'uploads/books'].forEach(dir => {
              list.push(normalizeUrl(`${rootPrefix}/${dir}/${raw}`));
              list.push(normalizeUrl(`${origin}/${dir}/${raw}`));
            });
          }
        }
        list.push(COVER_PLACEHOLDER);
        return Array.from(new Set(list.filter(Boolean)));
      };

      // Try candidates by loading each into a temporary Image first
      const tryCandidatesForImage = (img, list = [], timeoutMs = 2500) => {
        if (!Array.isArray(list) || !list.length) {
          img.src = COVER_PLACEHOLDER;
          return;
        }
        let idx = 0;
        const next = () => {
          if (idx >= list.length) {
            img.src = COVER_PLACEHOLDER;
            return;
          }
          const candidate = list[idx++];
          console.debug('[tryCandidatesForImage] test', idx - 1, candidate, 'for', img.alt || img.dataset.bookId || img);
           if (candidate === COVER_PLACEHOLDER) {
             img.src = COVER_PLACEHOLDER;
             return;
           }
           const tester = new Image();
           let finished = false;
           const timer = setTimeout(() => {
             if (!finished) {
               finished = true;
               next();
             }
           }, timeoutMs);
           tester.onload = () => {
             if (!finished) {
               finished = true;
               clearTimeout(timer);
               img.src = candidate;
               img.dataset.srcIdx = idx - 1;
              console.debug('[tryCandidatesForImage] loaded', candidate, img);
             }
           };
           tester.onerror = () => {
             if (!finished) {
               finished = true;
               clearTimeout(timer);
               next();
             }
           };
           tester.src = candidate;
         };
         img.src = COVER_PLACEHOLDER;
         next();
       };

      // onerror handler (reuse same global)
      window.imgFallback = window.imgFallback || function(img) {
         try {
           const list = (img.dataset.srcs || '').split('||').filter(Boolean);
           let idx = parseInt(img.dataset.srcIdx || '0', 10);
           idx++;
           if (idx < list.length) {
             img.dataset.srcIdx = idx;
             img.src = list[idx];
           } else {
             img.onerror = null;
             img.src = COVER_PLACEHOLDER;
           }
         } catch (e) {
           img.onerror = null;
           img.src = COVER_PLACEHOLDER;
         }
       };

      // initImages for details: test each candidate and set first valid src
      const initImages = (root = document) => {
        (root.querySelectorAll ? root.querySelectorAll('img[data-srcs]') : []).forEach(img => {
          const list = (img.dataset.srcs || '').split('||').filter(Boolean);
          if (!list.length) return;
          img.dataset.srcIdx = img.dataset.srcIdx || '0';
          img.src = COVER_PLACEHOLDER;
          tryCandidatesForImage(img, list);
          if (!img.onerror) img.onerror = function(){ window.imgFallback(this); };
          console.debug('initImages: candidates for', img, list);
        });
      };

      // Helper: attempt book-id lookup -> fill dataset.srcs and run tryCandidatesForImage
      const initBookImages = async (root = document) => {
        const imgs = root.querySelectorAll ? Array.from(root.querySelectorAll('img[data-book-id]:not([data-candidate-built])')) : [];
        await Promise.all(imgs.map(async (img) => {
          try {
            img.setAttribute('data-candidate-built', '1');
            const bookId = img.dataset.bookId || img.getAttribute('data-book-id');
            if (!bookId) return;
            // fetch book info
            const res = await fetch(`api/books.php?id=${encodeURIComponent(String(bookId))}`);
            const payload = await res.json().catch(() => null);
            const book = payload?.data ?? payload ?? null;
            const coverFromBook = book && (book.cover_image || book.cover || book.image || book.thumbnail || book.filename || book.path);
            const candidates = coverFromBook ? getCoverCandidates(coverFromBook) : getCoverCandidates(String(bookId));
            // set dataset using encoded URLs (no HTML escaping required for dataset)
            img.dataset.srcs = candidates.map(u => encodeURI(String(u))).join('||');
            img.dataset.srcIdx = '0';
            tryCandidatesForImage(img, candidates);
            if (!img.onerror) img.onerror = function(){ window.imgFallback(this); };
            console.debug('initBookImages: candidates for book', bookId, candidates);
          } catch (e) {
            console.debug('initBookImages error', e);
          }
        }));
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return d.toLocaleString('vi-VN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      };

      const getStatusBadge = (status) => {
        const badges = {
          'active': '<span class="badge bg-success">Active</span>',
          'returned': '<span class="badge bg-secondary">Returned</span>',
          'overdue': '<span class="badge bg-danger">Overdue</span>'
        };
        return badges[status] || escapeHtml(status) || '-';
      };

      fetch(`api/rentals.php?id=${encodeURIComponent(rentalId)}`)
        .then(async (res) => {
          const payload = await res.json().catch(() => null);
          if (!res.ok) throw new Error(payload?.error || 'Không tìm thấy thông tin thuê sách.');
          // Normalize rental object from possible response shapes
          const rental = (payload && (payload.data ?? payload)) || null;
          if (!rental || (typeof rental === 'object' && !rental.id && !rental.items)) {
            throw new Error(payload?.error || 'Không tìm thấy thông tin thuê sách.');
          }
          return rental;
        })
        .then((rental) => {
          const rentalFields = [
            { label: 'Rental ID', value: escapeHtml(rental.id ?? '-') },
            { label: 'Status', value: getStatusBadge(rental.status) },
            { label: 'Rental Date', value: escapeHtml(formatDate(rental.rental_date)) },
            { label: 'Due Date', value: escapeHtml(formatDate(rental.due_date)) },
            { label: 'Return Date', value: escapeHtml(formatDate(rental.return_date)) },
            { label: 'Notes', value: escapeHtml(rental.notes || '-') },
          ];

          const userFields = [
            { label: 'User ID', value: escapeHtml(rental.user_id ?? '-') },
            { label: 'Name', value: escapeHtml(rental.user_name ?? '-') },
            { label: 'Email', value: escapeHtml(rental.user_email ?? '-') },
          ];

          let booksHtml = '<div class="text-muted">No books in this rental.</div>';
          if (Array.isArray(rental.items) && rental.items.length > 0) {
            booksHtml = rental.items.map(it => {
              const title = escapeHtml(it.book_title || it.title || '-');
              const isbn = escapeHtml(it.book_isbn || it.isbn || '-');
              const author = escapeHtml(it.book_author || it.author || '-');
              const qty = escapeHtml(it.quantity ?? 1);
              const start = escapeHtml(formatDate(it.start_date));
              const end = escapeHtml(formatDate(it.end_date));
              const status = escapeHtml(it.status || '-');
              const coverValue = it.cover_image || it.cover || it.image || it.book_cover || it.cover_url || it.thumbnail;
              const candidates = coverValue ? getCoverCandidates(coverValue) : getCoverCandidates(String(it.book_id || it.book?.id || ''));
              // build src list (encode each URL), then escape only double quotes for safe attribute insertion
              const rawList = candidates.length ? candidates.map(u => encodeURI(String(u))).join('||') : '';
              const dataSrcs = rawList.replace(/"/g, '&quot;');
              const src0 = COVER_PLACEHOLDER;
 
              return `
                <div class="d-flex gap-3 align-items-start mb-3">
                  <div style="width:80px;">
                    <img src="${src0}" width="80" height="110" loading="lazy" decoding="async"
                         data-srcs="${dataSrcs}" data-src-idx="0"
                         data-book-id="${escapeHtml(it.book_id || it.book?.id || it.bookId || '')}"
                         onerror="console.debug('img failed', this.src); window.imgFallback(this)"
                         alt="${title}" style="width:80px;height:110px;object-fit:cover;border-radius:4px;">
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1">${title}</h6>
                    <div class="small text-muted">
                      <div><strong>ISBN:</strong> ${isbn}</div>
                      <div><strong>Author:</strong> ${author}</div>
                      <div><strong>Quantity:</strong> ${qty}</div>
                      <div><strong>Start:</strong> ${start}</div>
                      <div><strong>End:</strong> ${end}</div>
                      <div><strong>Item status:</strong> ${status}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          }

          detailsBody.innerHTML = `
            <div class="row g-4">
              <div class="col-12">
                <h5 class="mb-3 text-primary">Rental Details</h5>
                <div class="row g-4">
                  ${rentalFields
                    .map(
                      ({ label, value }) => `
                      <div class="col-md-6">
                        <div class="h-100">
                          <p class="text-uppercase text-muted small mb-1">${label}</p>
                          <p class="fs-5 mb-0 text-break">${value}</p>
                        </div>
                      </div>
                    `
                    )
                    .join('')}
                </div>
              </div>

              <div class="col-12">
                <hr>
                <h5 class="mb-3 text-primary">User Information</h5>
                <div class="row g-4">
                  ${userFields
                    .map(
                      ({ label, value }) => `
                        <div class="col-md-6">
                          <div class="h-100">
                            <p class="text-uppercase text-muted small mb-1">${label}</p>
                            <p class="fs-6 mb-0">${value}</p>
                          </div>
                        </div>
                      `
                    )
                    .join('')}
                </div>
              </div>

              <div class="col-12">
                <hr>
                <h5 class="mb-3 text-primary">Books</h5>
                <div>
                  ${booksHtml}
                </div>
              </div>
            </div>
          `;

          // initialize the image loaders for dynamic content
          initImages(detailsBody);
          initBookImages(detailsBody).catch(err => console.debug('initBookImages failed', err));
        })
        .catch((err) => {
          console.error('Error loading rental detail:', err);
          detailsBody.innerHTML = `<div class="alert alert-danger mb-0">Không thể tải thông tin thuê sách. ${escapeHtml(err?.message || String(err || ''))}</div>`;
        });
     })();
   </script>
</body>
</html>