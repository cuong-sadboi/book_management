<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Edit User | Book Management</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
	<div id="navbarInclude" data-include="../include/navbar.html"></div>
	<div class="layout-wrapper">
		<div id="sidebarInclude" data-include="../include/sidebar.html"></div>
		<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
		<main class="content-area">
			<div class="container">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-white border-0 pb-0">
						<h2 class="h4 mb-0">Edit user</h2>
					</div>
					<div class="card-body">
						<form id="userUpdateForm" class="row g-3">
							<input type="hidden" id="userId">
							<div class="col-md-6">
								<label for="name" class="form-label">Name *</label>
								<input type="text" id="name" class="form-control" required>
							</div>
							<div class="col-md-6">
								<label for="username" class="form-label">Username *</label>
								<input type="text" id="username" class="form-control" required>
							</div>
							<div class="col-md-6">
								<label for="email" class="form-label">Email *</label>
								<input type="email" id="email" class="form-control" required>
							</div>
							<div class="col-md-6">
								<label for="age" class="form-label">Age</label>
								<input type="number" id="age" class="form-control" min="1" max="150">
							</div>
							<div class="col-12">
								<label for="location" class="form-label">Location</label>
								<input type="text" id="location" class="form-control" placeholder="e.g., Hanoi, Vietnam">
							</div>
							<div class="col-12">
								<label for="bio" class="form-label">Note</label>
								<textarea id="bio" rows="4" class="form-control" placeholder="Short note..."></textarea>
							</div>
							<div class="col-12 d-flex justify-content-end gap-2 pt-3">
								<a href="index-user.html" class="btn btn-outline-secondary">Cancel</a>
								<button type="submit" class="btn btn-primary">Update user</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</main>
	</div>
	<div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="js/layout.js"></script>
	<script>
		document.querySelectorAll('[data-include]').forEach((node) => {
			fetch(node.dataset.include)
				.then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
				.then((html) => { node.innerHTML = html; window.initLayout?.(); })
				.catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
		});
	</script>
	<script>
		(() => {
			const form = document.getElementById('userUpdateForm');
			const params = new URLSearchParams(window.location.search);
			const id = params.get('id');

			if (!id) {
				form.innerHTML = '<div class="alert alert-warning mb-0">Missing user id.</div>';
				return;
			}

			fetch(`api/users.php?id=${encodeURIComponent(id)}`)
				.then((res) => res.json().then((data) => ({ ok: res.ok, data })))
				.then(({ ok, data }) => {
					if (!ok || data?.error || !data?.data) throw new Error(data?.error ?? 'User not found.');
					const user = data.data;
					form.querySelector('#userId').value = user.id;
					form.querySelector('#name').value = user.name ?? '';
					form.querySelector('#username').value = user.username ?? '';
					form.querySelector('#email').value = user.email ?? '';
					form.querySelector('#age').value = user.age ?? '';
					form.querySelector('#location').value = user.location ?? '';
					form.querySelector('#bio').value = user.bio ?? '';
				})
				.catch((error) => { form.innerHTML = `<div class="alert alert-danger mb-0">${error.message}</div>`; });

			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				const btn = form.querySelector('button[type="submit"]');
				const original = btn.textContent;
				btn.disabled = true; btn.textContent = 'Saving...';
				try {
					const payload = {
						id: Number(form.querySelector('#userId').value),
						name: form.querySelector('#name').value.trim(),
						username: form.querySelector('#username').value.trim(),
						email: form.querySelector('#email').value.trim(),
						age: form.querySelector('#age').value ? Number(form.querySelector('#age').value) : null,
						location: form.querySelector('#location').value.trim(),
						bio: form.querySelector('#bio').value.trim(),
					};

					const res = await fetch('api/users.php', {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload),
					});
					const data = await res.json();
					if (!res.ok || data?.error) throw new Error(data?.error || 'Unable to update.');
					window.location.href = 'index-user.html?updated=1';
				} catch (err) {
					alert(err.message || 'An unexpected error occurred.');
				} finally {
					btn.disabled = false; btn.textContent = original;
				}
			});
		})();
	</script>
</body>
</html>
