<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Quản lý Tác giả</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100">
  <div id="navbarInclude" data-include="../include/navbar.html"></div>
  <div class="layout-wrapper">
    <div id="sidebarInclude" data-include="../include/sidebar.html"></div>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    <main class="content-area">
      <div class="container py-4">
        <h1 class="mb-4 text-primary">Author Management</h1>

        <div class="controls row g-2 align-items-center mb-4">
          <div class="col-12 col-md-4">
            <input id="authorSearch" class="form-control" type="search" placeholder="Search by name, nationality...">
          </div>
          <div class="col-auto">
            <select id="authorPerPage" class="form-select">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="25">25</option>
            </select>
          </div>
          <div class="col d-flex flex-wrap gap-2">
            <button id="btnAuthorRefresh" class="btn btn-outline-primary">Refresh</button>
            <button id="btnAuthorAdd" class="btn btn-primary">Create</button>
            <button id="btnAuthorDeleteSelected" class="btn btn-danger">Delete Selected</button>
          </div>
        </div>

        <div class="table-responsive shadow-sm rounded">
          <table class="table table-striped table-hover align-middle mb-3">
            <thead>
              <tr>
                <th><input id="authorSelectAll" type="checkbox"></th>
                <th>Name</th>
                <th>Nationality</th>
                <th>Birth Year</th>
                <th>Bio</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="authorTbody"></tbody>
          </table>
        </div>

        <div class="pagination btn-group flex-wrap" id="authorPagination"></div>
      </div>
    </main>
  </div>
  <div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="js/layout.js"></script>
  <script>
    document.querySelectorAll('[data-include]').forEach((node) => {
      fetch(node.dataset.include)
        .then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
        .then((html) => { node.innerHTML = html; window.initLayout?.(); })
        .catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
    });
  </script>
  <script>
    (() => {
      const API = 'api/authors.php';
      const tbody = document.getElementById('authorTbody');
      const pagination = document.getElementById('authorPagination');
      const searchInput = document.getElementById('authorSearch');
      const perPageSelect = document.getElementById('authorPerPage');
      const btnRefresh = document.getElementById('btnAuthorRefresh');
      const btnAdd = document.getElementById('btnAuthorAdd');
      const btnDeleteSelected = document.getElementById('btnAuthorDeleteSelected');
      const selectAll = document.getElementById('authorSelectAll');

      const state = { q: '', page: 1, limit: Number(perPageSelect.value) || 10 };
      let debounceId;
      let currentAbortController;

      const escapeHtml = (value = '') =>
        value.toString().replace(/[&<>"']/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch]));

      async function loadAuthors() {
        const params = new URLSearchParams({ page: state.page, per_page: state.limit });
        if (state.q) params.append('q', state.q);

        currentAbortController?.abort();
        const controller = new AbortController();
        currentAbortController = controller;

        try {
          const res = await fetch(`${API}?${params.toString()}`, { signal: controller.signal });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          const authors = payload.data ?? [];
          const total = payload.meta?.total ?? authors.length;

          if (total > 0 && authors.length === 0 && state.page > 1) {
            state.page = Math.max(1, Math.ceil(total / state.limit));
            return loadAuthors();
          }

          renderRows(authors);
          renderPagination(total);
          selectAll.checked = false;
        } catch (error) {
          if (error.name === 'AbortError') return;
          tbody.innerHTML = `<tr><td colspan="6">Không thể tải dữ liệu: ${escapeHtml(error.message)}</td></tr>`;
          pagination.innerHTML = '';
          selectAll.checked = false;
        } finally {
          if (currentAbortController === controller) currentAbortController = null;
        }
      }

      function renderRows(authors) {
        if (!authors.length) {
          tbody.innerHTML = '<tr><td colspan="6">Không có dữ liệu.</td></tr>';
          return;
        }
        tbody.innerHTML = authors.map((author) => `
          <tr data-id="${author.id ?? ''}">
            <td><input type="checkbox" data-id="${author.id ?? ''}"></td>
            <td>${escapeHtml(author.name ?? '')}</td>
            <td>${escapeHtml(author.nationality ?? '')}</td>
            <td>${author.birth_year ?? ''}</td>
            <td class="text-truncate" style="max-width: 260px;">${escapeHtml(author.bio ?? '')}</td>
            <td>
              <div class="d-flex flex-column gap-1">
                <button class="btn-edit btn btn-sm btn-outline-primary d-inline-flex align-items-center justify-content-center" data-id="${author.id ?? ''}" title="Edit" aria-label="Edit">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zM12.5 5.5 10.207 3.207 4 9.414V11h1.586z"/></svg>
                </button>
                <button class="btn-delete btn btn-sm btn-outline-danger d-inline-flex align-items-center justify-content-center" data-id="${author.id ?? ''}" title="Delete" aria-label="Delete">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function renderPagination(total) {
        const totalPages = Math.max(1, Math.ceil(total / state.limit));
        pagination.innerHTML = '';
        for (let page = 1; page <= totalPages; page += 1) {
          const btn = document.createElement('button');
          btn.textContent = page;
          if (page === state.page) {
            btn.disabled = true;
            btn.classList.add('active');
          }
          btn.addEventListener('click', () => {
            if (page === state.page) return;
            state.page = page;
            loadAuthors();
          });
          pagination.appendChild(btn);
        }
      }

      perPageSelect.addEventListener('change', () => {
        state.limit = Number(perPageSelect.value) || 10;
        state.page = 1;
        loadAuthors();
      });

      searchInput.addEventListener('input', ({ target }) => {
        const nextQuery = target.value.trim();
        clearTimeout(debounceId);
        debounceId = setTimeout(() => {
          if (state.q === nextQuery) return;
          state.q = nextQuery;
          state.page = 1;
          loadAuthors();
        }, 300);
      });

      btnRefresh.addEventListener('click', () => loadAuthors());

      selectAll.addEventListener('change', (event) => {
        tbody.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          checkbox.checked = event.target.checked;
        });
      });

      btnDeleteSelected.addEventListener('click', () => {
        const ids = Array.from(tbody.querySelectorAll('input[type="checkbox"]:checked'))
          .map((checkbox) => checkbox.dataset.id)
          .filter(Boolean);
        if (!ids.length) {
          alert('Please select at least one author.');
          return;
        }
        if (!confirm(`Delete ${ids.length} selected author(s)?`)) return;

        btnDeleteSelected.disabled = true;
        fetch(API, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids }),
        })
          .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if (!ok || data?.error) throw new Error(data?.error ?? 'Unable to delete.');
            loadAuthors();
          })
          .catch((error) => alert(error.message || 'Delete failed.'))
          .finally(() => { btnDeleteSelected.disabled = false; });
      });

      btnAdd.addEventListener('click', () => { window.location.href = 'create-author.html'; });

      tbody.addEventListener('click', (event) => {
        const deleteBtn = event.target.closest('.btn-delete');
        if (deleteBtn?.dataset.id) {
          event.stopPropagation();
          if (!confirm('Are you sure you want to delete this author?')) return;
          fetch(API, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: deleteBtn.dataset.id }),
          })
            .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
            .then(({ ok, data }) => {
              if (!ok || data?.error) throw new Error(data?.error ?? 'Unable to delete author.');
              loadAuthors();
            })
            .catch((error) => alert(error.message || 'Delete failed.'));
          return;
        }

        const editBtn = event.target.closest('.btn-edit');
        if (editBtn?.dataset.id) {
          event.stopPropagation();
          window.location.href = `update-author.html?id=${editBtn.dataset.id}`;
          return;
        }

        const interactive = event.target.closest('input, button, a, label');
        if (interactive) return;
        const row = event.target.closest('tr[data-id]');
        if (!row?.dataset.id) return;
        window.location.href = `update-author.html?id=${row.dataset.id}`;
      });

      loadAuthors();
    })();
  </script>
</body>
</html>
