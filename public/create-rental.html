<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Create Rental | Book Management</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="css/style.css">
	<style>
		.book-item {
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 1rem;
			margin-bottom: 1rem;
			background-color: #f8f9fa;
			position: relative;
		}
		.book-item .btn-remove {
			position: absolute;
			top: 0.5rem;
			right: 0.5rem;
		}
		.book-cover-small {
			width: 80px;
			height: 110px;
			object-fit: cover;
			border-radius: 0.25rem;
		}
		#bookSearchModal .book-search-item {
			cursor: pointer;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 0.75rem;
			margin-bottom: 0.5rem;
			transition: all 0.2s;
		}
		#bookSearchModal .book-search-item:hover {
			background-color: #f8f9fa;
			border-color: #0d6efd;
		}
		#bookSearchModal .book-search-item img {
			width: 50px;
			height: 70px;
			object-fit: cover;
		}
		.user-search-container {
			position: relative;
		}
		.user-search-results {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			z-index: 1000;
			max-height: 300px;
			overflow-y: auto;
			background: white;
			border: 1px solid #dee2e6;
			border-top: none;
			border-radius: 0 0 0.375rem 0.375rem;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			display: none;
		}
		.user-search-results.show {
			display: block;
		}
		.user-search-item {
			padding: 0.75rem 1rem;
			cursor: pointer;
			border-bottom: 1px solid #f0f0f0;
		}
		.user-search-item:hover {
			background-color: #f8f9fa;
		}
		.user-search-item:last-child {
			border-bottom: none;
		}
		.user-search-item.create-new {
			background-color: #e7f3ff;
			color: #0d6efd;
			font-weight: 500;
		}
		.user-search-item.create-new:hover {
			background-color: #d0e8ff;
		}
		.selected-user-card {
			background-color: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 1rem;
		}
		.new-user-form {
			background-color: #fff3cd;
			border: 1px solid #ffc107;
			border-radius: 0.375rem;
			padding: 1rem;
		}
	</style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
	<div id="navbarInclude" data-include="../include/navbar.html"></div>
	<div class="layout-wrapper">
		<div id="sidebarInclude" data-include="../include/sidebar.html"></div>
		<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
		<main class="content-area">
			<div class="container">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-white border-0 pb-0">
						<h2 class="h4 mb-0">Create new rental</h2>
					</div>
					<div class="card-body">
						<form id="rentalForm" class="row g-3">
							<!-- User Search Section -->
							<div class="col-12">
								<label class="form-label required">User</label>
								<div class="user-search-container">
									<input type="text" id="userSearchInput" class="form-control" placeholder="Search user by name or email..." autocomplete="off">
									<div id="userSearchResults" class="user-search-results"></div>
								</div>
								<input type="hidden" id="userId" name="user_id">
							</div>

							<!-- Selected User Display -->
							<div class="col-12" id="selectedUserContainer" style="display: none;">
								<div class="selected-user-card d-flex justify-content-between align-items-center">
									<div>
										<strong id="selectedUserName"></strong>
										<br>
										<small class="text-muted" id="selectedUserEmail"></small>
									</div>
									<button type="button" class="btn btn-sm btn-outline-danger" id="clearUserBtn">
										<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
											<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
										</svg>
										Change
									</button>
								</div>
							</div>

							<!-- New User Form (hidden by default) -->
							<div class="col-12" id="newUserContainer" style="display: none;">
								<div class="new-user-form">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h6 class="mb-0">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
												<path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
												<path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
											</svg>
											Create New User
										</h6>
										<button type="button" class="btn btn-sm btn-outline-secondary" id="cancelNewUserBtn">Cancel</button>
									</div>
									<div class="row g-2">
										<div class="col-md-6">
											<label class="form-label required">Name</label>
											<input type="text" id="newUserName" class="form-control" placeholder="Enter name">
										</div>
										<div class="col-md-6">
											<label class="form-label required">Email</label>
											<input type="email" id="newUserEmail" class="form-control" placeholder="Enter email">
										</div>
										<div class="col-md-6">
											<label class="form-label">Phone</label>
											<input type="text" id="newUserPhone" class="form-control" placeholder="Enter phone (optional)">
										</div>
										<div class="col-md-6">
											<label class="form-label">Username</label>
											<input type="text" id="newUserUsername" class="form-control" placeholder="Enter username (optional)">
										</div>
									</div>
								</div>
							</div>

							<!-- Due Date -->
							<div class="col-md-6">
								<label for="dueDate" class="form-label required">Due Date</label>
								<input type="datetime-local" id="dueDate" class="form-control" required>
							</div>

							<!-- Notes -->
							<div class="col-12">
								<label for="notes" class="form-label">Notes</label>
								<textarea id="notes" rows="2" class="form-control" placeholder="Optional notes..."></textarea>
							</div>

							<!-- Books Section -->
							<div class="col-12">
								<label class="form-label required">Books</label>
								<div id="bookItemsContainer">
									<div class="book-item row g-2 align-items-end mb-2">
										<div class="col-md-6">
											<select name="book_id[]" class="form-select book-select" required>
												<option value="">-- Select Book --</option>
											</select>
										</div>
										<div class="col-md-3">
											<input type="number" name="quantity[]" class="form-control" value="1" min="1" placeholder="Qty">
										</div>
										<div class="col-md-3">
											<button type="button" class="btn btn-danger btn-remove-book" disabled>Remove</button>
										</div>
									</div>
								</div>
								<button type="button" id="btnAddBook" class="btn btn-outline-secondary mt-2">+ Add Book</button>
							</div>

							<div class="col-12 d-flex justify-content-end gap-2 pt-3">
								<a href="index-rental.html" class="btn btn-outline-secondary">Cancel</a>
								<button type="submit" class="btn btn-primary">Create Rental</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</main>
	</div>
	<div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

	<!-- Book Search Modal -->
	<div class="modal fade" id="bookSearchModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Select Book</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<input type="text" id="bookSearchInput" class="form-control" placeholder="Search by title, author, or ISBN...">
					</div>
					<div id="bookSearchResults" style="max-height: 400px; overflow-y: auto;">
						<div class="text-center text-muted py-3">
							<p>Type to search for books...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="js/layout.js"></script>
	<script>
		(() => {
			document.querySelectorAll('[data-include]').forEach((node) => {
				fetch(node.dataset.include)
					.then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
					.then((html) => { node.innerHTML = html; window.initLayout?.(); })
					.catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
			});

			// Get hidden book IDs from localStorage
			const BOOK_HIDDEN_KEY = 'book_hidden_ids';
			const getHiddenBookIds = () => {
				try {
					return new Set(JSON.parse(localStorage.getItem(BOOK_HIDDEN_KEY) || '[]').map(String));
				} catch {
					return new Set();
				}
			};

			const booksList = document.getElementById('booksList');
			let rentalBooks = [];
			let allBooks = [];
			const bookSearchModal = new bootstrap.Modal(document.getElementById('bookSearchModal'));

			// Escape HTML
			const escapeHtml = (text) => {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			};

			// Resolve cover image URL with sensible fallbacks
			const getCoverCandidates = (cover) => {
				const placeholder = 'https://via.placeholder.com/80x110?text=No+Cover';
				const p = window.location.pathname;
				const idx = p.indexOf('/public/');
				const baseRoot = idx !== -1 ? p.substring(0, idx) : '';
				const rootPrefix = window.location.origin + baseRoot;

				if (!cover) return [placeholder];
				const s = String(cover).trim();
				const c = [];
				if (/^https?:\/\//i.test(s)) {
					c.push(s);
				} else if (s.startsWith('//')) {
					c.push(window.location.protocol + s);
				} else {
					const raw = s.replace(/^\/+/, '');
					const patterns = [
						`${rootPrefix}/public/${raw}`,
						`${rootPrefix}/${raw}`,
						`${window.location.origin}/public/${raw}`,
						`${window.location.origin}/${raw}`,
						`${rootPrefix}/public/uploads/books/${raw}`,
						`${rootPrefix}/public/uploads/${raw}`,
						`${rootPrefix}/uploads/books/${raw}`,
						`${rootPrefix}/uploads/${raw}`,
						`${window.location.origin}/uploads/books/${raw}`,
						`${window.location.origin}/uploads/${raw}`,
						`./${raw}`,
						`../${raw}`
					];
					patterns.forEach(u => {
						try {
							c.push(encodeURI(u.replace(/([^:]\/)\/+/g, '$1')));
						} catch (e) {
							c.push(u.replace(/([^:]\/)\/+/g, '$1'));
						}
					});
				}
				c.push(placeholder);
				return Array.from(new Set(c.filter(Boolean)));
			};

			// Try candidates by loading each into temporary Image
			const tryCandidatesForImage = (img, list = [], timeoutMs = 2500) => {
				if (!Array.isArray(list) || !list.length) {
					img.src = 'https://via.placeholder.com/80x110?text=No+Cover';
					return;
				}
				let idx = 0;
				const next = () => {
					if (idx >= list.length) {
						img.src = 'https://via.placeholder.com/80x110?text=No+Cover';
						return;
					}
					const candidate = list[idx++];
					console.debug('[tryCandidates]', idx - 1, candidate);
					if (candidate === 'https://via.placeholder.com/80x110?text=No+Cover') {
						img.src = candidate;
						return;
					}
					const tester = new Image();
					let finished = false;
					const timer = setTimeout(() => {
						if (!finished) {
							finished = true;
							next();
						}
					}, timeoutMs);
					tester.onload = () => {
						if (!finished) {
							finished = true;
							clearTimeout(timer);
							img.src = candidate;
							img.dataset.srcIdx = idx - 1;
							console.debug('[tryCandidates] loaded', candidate);
						}
					};
					tester.onerror = () => {
						if (!finished) {
							finished = true;
							clearTimeout(timer);
							next();
						}
					};
					tester.src = candidate;
				};
				img.src = 'https://via.placeholder.com/80x110?text=No+Cover';
				next();
			};

			// onerror handler to try next candidate
			window.imgFallback = function(img) {
				try {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					let idx = parseInt(img.dataset.srcIdx || '0', 10);
					idx++;
					if (idx < list.length) {
						img.dataset.srcIdx = idx;
						img.src = list[idx];
					} else {
						img.onerror = null;
					}
				} catch (e) {
					img.onerror = null;
				}
			};

			// initialize imgs with data-srcs by testing candidates
			const initImages = (root = document) => {
				(root.querySelectorAll ? root.querySelectorAll('img[data-srcs]') : []).forEach(img => {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					if (!list.length) return;
					img.dataset.srcIdx = img.dataset.srcIdx || '0';
					tryCandidatesForImage(img, list);
					if (!img.onerror) img.onerror = function(){ window.imgFallback(this); };
					console.debug('initImages candidates:', img, list);
				});
			};

			// Render books list
			const renderBooksList = () => {
				if (rentalBooks.length === 0) {
					booksList.innerHTML = '<div class="alert alert-info mb-0">No book selected. Click "Add Book" to select books for this rental.</div>';
					return;
				}

				booksList.innerHTML = rentalBooks.map(book => {
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(u => encodeURI(String(u))).join('||');
					return `
						<div class="book-item" data-book-id="${book.id}">
							<button type="button" class="btn btn-sm btn-danger btn-remove" onclick="removeBook(${book.id})">
								<i class="bi bi-trash"></i> Remove
							</button>
							<div class="row align-items-start">
								<div class="col-auto">
									<img src="https://via.placeholder.com/80x110?text=No+Cover" 
										 width="80" height="110" loading="lazy" decoding="async"
										 data-srcs="${escapeHtml(dataSrcs)}" 
										 data-src-idx="0"
										 onerror="window.imgFallback(this)" 
										 alt="${escapeHtml(book.title || '')}" 
										 class="book-cover-small" 
										 style="border: 1px solid #dee2e6;">
								</div>
								<div class="col">
									<h6 class="mb-1">${escapeHtml(book.title || 'N/A')}</h6>
									<div class="small text-muted">
										<div><strong>ISBN:</strong> ${escapeHtml(book.isbn || 'N/A')}</div>
										<div><strong>Author:</strong> ${escapeHtml(book.author || 'N/A')}</div>
										<div><strong>Publisher:</strong> ${escapeHtml(book.publisher || 'N/A')}</div>
										<div><strong>Stock:</strong> ${book.stock || 0}</div>
									</div>
								</div>
							</div>
						</div>
					`;
				}).join('');
				initImages(booksList);
			};

			// Add book to rental
			window.addBookToRental = (bookId) => {
				const book = allBooks.find(b => b.id === bookId);
				if (!book) return;
				
				// Check if book already added
				if (rentalBooks.some(b => b.id === bookId)) {
					alert('This book is already selected for the rental.');
					return;
				}

				// Check if book is available for rental
				if (Number(book.is_rental) !== 1) {
					alert('This book is not available for rental.');
					return;
				}

				if (Number(book.stock) <= 0) {
					alert('This book is out of stock.');
					return;
				}

				rentalBooks.push(book);
				renderBooksList();
				bookSearchModal.hide();
				updateAddBookButton();
			};

			// Remove book from list
			window.removeBook = (bookId) => {
				if (confirm('Are you sure you want to remove this book from the rental?')) {
					rentalBooks = rentalBooks.filter(b => b.id !== bookId);
					renderBooksList();
					updateAddBookButton();
				}
			};

			// Get available rental books (filtered)
			const getAvailableRentalBooks = () => {
				const hiddenIds = getHiddenBookIds();
				return allBooks.filter(book => {
					const isRental = Number(book.is_rental) === 1;
					const hasStock = Number(book.stock) > 0;
					const notHidden = !hiddenIds.has(String(book.id));
					return isRental && hasStock && notHidden;
				});
			};

			// Render books in search modal
			const renderBookSearchResults = (books) => {
				if (books.length === 0) {
					bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No books found.</p></div>';
					return;
				}

				bookSearchResults.innerHTML = books.map(book => {
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(u => encodeURI(String(u))).join('||');
					return `
						<div class="book-search-item d-flex align-items-center" onclick="addBookToRental(${book.id})">
							<img src="https://via.placeholder.com/50x70?text=No+Cover" 
								 width="50" height="70" loading="lazy" decoding="async"
								 data-srcs="${escapeHtml(dataSrcs)}" 
								 data-src-idx="0"
								 onerror="window.imgFallback(this)" 
								 alt="${escapeHtml(book.title || '')}" 
								 class="me-3" 
								 style="width:50px;height:70px;object-fit:cover;border-radius:4px;">
							<div class="flex-grow-1">
								<h6 class="mb-1">${escapeHtml(book.title || 'Unknown')}</h6>
								<div class="small text-muted">
									${escapeHtml(book.author || 'Unknown Author')} • ${escapeHtml(book.isbn || 'No ISBN')} • Stock: ${book.stock || 0}
								</div>
							</div>
						</div>
					`;
				}).join('');
				initImages(bookSearchResults);
			};

			// Book search functionality
			const bookSearchInput = document.getElementById('bookSearchInput');
			const bookSearchResults = document.getElementById('bookSearchResults');
			const hiddenIds = getHiddenBookIds();

			bookSearchInput.addEventListener('input', (e) => {
				const query = e.target.value.toLowerCase().trim();
				const availableBooks = getAvailableRentalBooks();
				
				let filtered;
				if (query.length === 0) {
					// Show all available books when query is empty
					filtered = availableBooks;
				} else {
					filtered = availableBooks.filter(book => {
						return (book.title?.toLowerCase().includes(query) ||
								book.author?.toLowerCase().includes(query) ||
								book.isbn?.toLowerCase().includes(query));
					});
				}

				renderBookSearchResults(filtered);
			});

			// Show add book modal
			document.getElementById('addBookBtn').addEventListener('click', () => {
				bookSearchInput.value = '';
				// Show all available books when modal opens
				if (allBooks.length > 0) {
					const availableBooks = getAvailableRentalBooks();
					renderBookSearchResults(availableBooks);
				} else {
					bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Loading books...</p></div>';
					// Try to load books if not loaded yet
					fetch('api/db.php?limit=1000')
						.then(res => res.json())
						.then(data => {
							if (data.success && data.data) {
								allBooks = data.data;
								const availableBooks = getAvailableRentalBooks();
								renderBookSearchResults(availableBooks);
							} else {
								bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No books available.</p></div>';
							}
						})
						.catch(() => {
							bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Error loading books.</p></div>';
						});
				}
				bookSearchModal.show();
			});

			// Load users
			fetch('api/users.php?per_page=1000')
				.then(res => res.json())
				.then(data => {
					const select = document.getElementById('user_id');
					(data.data || []).forEach(u => {
						const opt = document.createElement('option');
						opt.value = u.id;
						opt.textContent = `${u.name} (${u.email})`;
						select.appendChild(opt);
					});
				})
				.catch(err => {
					console.error('Error loading users:', err);
				});

			// Load all books for search
			fetch('api/db.php?limit=1000')
				.then(res => res.json())
				.then(data => {
					if (data.success && data.data) {
						allBooks = data.data;
					}
				})
				.catch(err => {
					console.error('Error loading books:', err);
				});

			// Helper function to get current datetime in Vietnam timezone for datetime-local input
			const getVietnamDateTimeLocal = (addDays = 0) => {
				const now = new Date();
				// Convert to Vietnam timezone string then parse back
				const vnOptions = { 
					timeZone: 'Asia/Ho_Chi_Minh', 
					year: 'numeric', 
					month: '2-digit', 
					day: '2-digit', 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: false 
				};
				const parts = new Intl.DateTimeFormat('en-CA', vnOptions).formatToParts(now);
				
				let year = '', month = '', day = '', hour = '', minute = '';
				parts.forEach(p => {
					if (p.type === 'year') year = p.value;
					if (p.type === 'month') month = p.value;
					if (p.type === 'day') day = p.value;
					if (p.type === 'hour') hour = p.value;
					if (p.type === 'minute') minute = p.value;
				});
				
				// Create date in Vietnam timezone
				let vnDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
				
				// Add days if needed
				if (addDays > 0) {
					vnDate.setDate(vnDate.getDate() + addDays);
				}
				
				const y = vnDate.getFullYear();
				const m = String(vnDate.getMonth() + 1).padStart(2, '0');
				const d = String(vnDate.getDate()).padStart(2, '0');
				const h = String(vnDate.getHours()).padStart(2, '0');
				const min = String(vnDate.getMinutes()).padStart(2, '0');
				
				return `${y}-${m}-${d}T${h}:${min}`;
			};

			// Helper function to convert datetime-local to MySQL format
			const toMySQLDateTime = (dateTimeLocalValue) => {
				if (!dateTimeLocalValue) return null;
				return dateTimeLocalValue.replace('T', ' ') + ':00';
			};

			// Set default due date (14 days from now in Vietnam timezone)
			const dueDateInput = document.getElementById('dueDate');
			if (dueDateInput) {
				dueDateInput.value = getVietnamDateTimeLocal(14);
			}

			// Form submit
			document.getElementById('rentalForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				const form = e.target;
				const btn = form.querySelector('button[type="submit"]');
				const original = btn.textContent;
				btn.disabled = true; 
				btn.textContent = 'Creating...';
				
				// Validate
				if (!form.user_id.value) {
					alert('Please select a user.');
					btn.disabled = false;
					btn.textContent = original;
					return;
				}

				if (rentalBooks.length === 0) {
					alert('Please select at least one book for the rental.');
					btn.disabled = false;
					btn.textContent = original;
					return;
				}

				try {
					const userId = parseInt(form.user_id.value);
					const dueDate = form.due_date.value ? form.due_date.value.replace('T', ' ') + ':00' : null;
					const notes = form.notes.value.trim();

					// Build items array for single POST
					const items = rentalBooks.map(b => ({
						book_id: b.id,
						quantity: b.quantity ?? 1,
						start_date: null,
						end_date: dueDate
					}));

					const payload = {
						user_id: userId,
						items: items,
						due_date: dueDate,
						notes: notes
					};

					const res = await fetch('api/rentals.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const data = await res.json();
					if (!res.ok || data?.error) {
						const msg = data?.error || 'Unknown error';
						alert(`Failed to create rental: ${msg}`);
					} else {
						alert('Rental created successfully.');
						window.location.href = 'index-rental.html?created=1';
					}
				} catch (err) {
					alert(err.message || 'An error occurred while creating rentals.');
				} finally {
					btn.disabled = false; 
					btn.textContent = original;
				}
			});

			const MAX_BOOKS = 5; // Maximum number of books allowed
			const btnAddBook = document.getElementById('addBookBtn');
			const bookItemsContainer = document.getElementById('booksList');

			const updateAddBookButton = () => {
				const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
				if (currentCount >= MAX_BOOKS) {
					btnAddBook.disabled = true;
					btnAddBook.textContent = `Maximum ${MAX_BOOKS} books reached`;
					btnAddBook.classList.add('btn-secondary');
					btnAddBook.classList.remove('btn-outline-secondary');
				} else {
					btnAddBook.disabled = false;
					btnAddBook.textContent = '+ Add Book';
					btnAddBook.classList.remove('btn-secondary');
					btnAddBook.classList.add('btn-outline-secondary');
				}
			};

			const updateRemoveButtons = () => {
				const items = bookItemsContainer.querySelectorAll('.book-item');
				items.forEach((item, idx) => {
					const btn = item.querySelector('.btn-remove-book');
					btn.disabled = items.length <= 1;
				});
				updateAddBookButton(); // Also update add button state
			};

			btnAddBook.addEventListener('click', () => {
				const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
				if (currentCount >= MAX_BOOKS) {
					alert(`You can only add up to ${MAX_BOOKS} books per rental.`);
					return;
				}
				
				const newItem = document.createElement('div');
				newItem.className = 'book-item row g-2 align-items-end mb-2';
				newItem.innerHTML = `
					<div class="col-md-6">
						<label class="form-label">Book <span class="text-danger">*</span></label>
						<select name="book_id[]" class="form-select book-select" required>
							<option value="">-- Select Book --</option>
						</select>
					</div>
					<div class="col-md-3">
						<label class="form-label">Quantity</label>
						<input type="number" name="quantity[]" class="form-control" value="1" min="1">
					</div>
					<div class="col-md-3">
						<button type="button" class="btn btn-danger btn-remove-book">Remove</button>
					</div>
				`;
				bookItemsContainer.appendChild(newItem);
				populateBookSelects();
				updateRemoveButtons();
			});

			bookItemsContainer.addEventListener('click', (e) => {
				if (e.target.classList.contains('btn-remove-book')) {
					e.target.closest('.book-item').remove();
					updateRemoveButtons();
				}
			});

			// Initialize button states on page load
			updateRemoveButtons();
		})();
	</script>
	<script>
		(() => {
			const form = document.getElementById('rentalForm');
			const bookItemsContainer = document.getElementById('bookItemsContainer');
			const btnAddBook = document.getElementById('btnAddBook');
			
			// User search elements
			const userSearchInput = document.getElementById('userSearchInput');
			const userSearchResults = document.getElementById('userSearchResults');
			const userIdInput = document.getElementById('userId');
			const selectedUserContainer = document.getElementById('selectedUserContainer');
			const selectedUserName = document.getElementById('selectedUserName');
			const selectedUserEmail = document.getElementById('selectedUserEmail');
			const clearUserBtn = document.getElementById('clearUserBtn');
			
			// New user form elements
			const newUserContainer = document.getElementById('newUserContainer');
			const newUserName = document.getElementById('newUserName');
			const newUserEmail = document.getElementById('newUserEmail');
			const newUserPhone = document.getElementById('newUserPhone');
			const newUserUsername = document.getElementById('newUserUsername');
			const cancelNewUserBtn = document.getElementById('cancelNewUserBtn');

			const MAX_BOOKS = 5;
			let allBooks = [];
			let allUsers = [];
			let searchDebounce;
			let isCreatingNewUser = false;

			const escapeHtml = (text) => {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			};

			// Vietnam timezone helper
			const getVietnamDateTimeLocal = (addDays = 0) => {
				const now = new Date();
				const vnOptions = { 
					timeZone: 'Asia/Ho_Chi_Minh', 
					year: 'numeric', 
					month: '2-digit', 
					day: '2-digit', 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: false 
				};
				const parts = new Intl.DateTimeFormat('en-CA', vnOptions).formatToParts(now);
				
				let year = '', month = '', day = '', hour = '', minute = '';
				parts.forEach(p => {
					if (p.type === 'year') year = p.value;
					if (p.type === 'month') month = p.value;
					if (p.type === 'day') day = p.value;
					if (p.type === 'hour') hour = p.value;
					if (p.type === 'minute') minute = p.value;
				});
				
				let vnDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
				if (addDays > 0) {
					vnDate.setDate(vnDate.getDate() + addDays);
				}
				
				const y = vnDate.getFullYear();
				const m = String(vnDate.getMonth() + 1).padStart(2, '0');
				const d = String(vnDate.getDate()).padStart(2, '0');
				const h = String(vnDate.getHours()).padStart(2, '0');
				const min = String(vnDate.getMinutes()).padStart(2, '0');
				
				return `${y}-${m}-${d}T${h}:${min}`;
			};

			// Set default due date (14 days from now)
			document.getElementById('dueDate').value = getVietnamDateTimeLocal(14);

			// Load users
			const loadUsers = async () => {
				try {
					const res = await fetch('api/users.php?per_page=10000');
					const data = await res.json();
					allUsers = (data.data || data || []).filter(u => !u.deleted_at);
				} catch (e) {
					console.error('Error loading users:', e);
					allUsers = [];
				}
			};

			// Search users
			const searchUsers = (query) => {
				const q = query.toLowerCase().trim();
				if (!q) return allUsers.slice(0, 10);
				
				return allUsers.filter(u => 
					(u.name && u.name.toLowerCase().includes(q)) ||
					(u.email && u.email.toLowerCase().includes(q)) ||
					(u.username && u.username.toLowerCase().includes(q))
				).slice(0, 10);
			};

			// Render search results
			const renderSearchResults = (users, query) => {
				let html = '';
				
				if (users.length > 0) {
					html = users.map(u => `
						<div class="user-search-item" data-user-id="${u.id}" data-name="${escapeHtml(u.name)}" data-email="${escapeHtml(u.email)}">
							<strong>${escapeHtml(u.name)}</strong>
							<br>
							<small class="text-muted">${escapeHtml(u.email)}</small>
						</div>
					`).join('');
				}
				
				// Always show "Create new user" option
				if (query.trim()) {
					html += `
						<div class="user-search-item create-new" data-action="create-new">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-2" viewBox="0 0 16 16">
								<path d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
								<path fill-rule="evenodd" d="M13.5 5a.5.5 0 0 1 .5.5V7h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V8h-1.5a.5.5 0 0 1 0-1H13V5.5a.5.5 0 0 1 .5-.5z"/>
							</svg>
							Create new user "${escapeHtml(query)}"
						</div>
					`;
				} else if (users.length === 0) {
					html = `
						<div class="user-search-item text-muted" style="cursor: default;">
							No users found. Type to search or create new.
						</div>
					`;
				}
				
				userSearchResults.innerHTML = html;
				userSearchResults.classList.add('show');
				
				// Attach click handlers
				userSearchResults.querySelectorAll('.user-search-item[data-user-id]').forEach(item => {
					item.addEventListener('click', () => selectUser(item.dataset.userId, item.dataset.name, item.dataset.email));
				});
				
				userSearchResults.querySelector('.user-search-item[data-action="create-new"]')?.addEventListener('click', () => {
					showNewUserForm(query);
				});
			};

			// Select existing user
			const selectUser = (userId, name, email) => {
				userIdInput.value = userId;
				selectedUserName.textContent = name;
				selectedUserEmail.textContent = email;
				
				userSearchInput.style.display = 'none';
				userSearchResults.classList.remove('show');
				selectedUserContainer.style.display = 'block';
				newUserContainer.style.display = 'none';
				isCreatingNewUser = false;
			};

			// Show new user form
			const showNewUserForm = (searchQuery) => {
				userSearchInput.style.display = 'none';
				userSearchResults.classList.remove('show');
				selectedUserContainer.style.display = 'none';
				newUserContainer.style.display = 'block';
				isCreatingNewUser = true;
				
				// Pre-fill name or email based on search query
				if (searchQuery.includes('@')) {
					newUserEmail.value = searchQuery;
					newUserName.value = '';
				} else {
					newUserName.value = searchQuery;
					newUserEmail.value = '';
				}
				
				userIdInput.value = '';
				newUserName.focus();
			};

			// Clear user selection
			const clearUserSelection = () => {
				userIdInput.value = '';
				userSearchInput.value = '';
				userSearchInput.style.display = 'block';
				selectedUserContainer.style.display = 'none';
				newUserContainer.style.display = 'none';
				isCreatingNewUser = false;
				newUserName.value = '';
				newUserEmail.value = '';
				newUserPhone.value = '';
				newUserUsername.value = '';
				userSearchInput.focus();
			};

			// User search input handler
			userSearchInput.addEventListener('input', (e) => {
				clearTimeout(searchDebounce);
				searchDebounce = setTimeout(() => {
					const query = e.target.value;
					const results = searchUsers(query);
					renderSearchResults(results, query);
				}, 200);
			});

			userSearchInput.addEventListener('focus', () => {
				const results = searchUsers(userSearchInput.value);
				renderSearchResults(results, userSearchInput.value);
			});

			// Hide search results when clicking outside
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.user-search-container')) {
					userSearchResults.classList.remove('show');
				}
			});

			// Clear user button
			clearUserBtn.addEventListener('click', clearUserSelection);

			// Cancel new user button
			cancelNewUserBtn.addEventListener('click', clearUserSelection);

			// Load books
			const loadBooks = async () => {
				try {
					const res = await fetch('api/books.php?per_page=10000');
					const data = await res.json();
					allBooks = (data.data || data || []).filter(b => !b.deleted_at && b.is_rental == 1 && b.stock > 0);
					populateBookSelects();
				} catch (e) {
					console.error('Error loading books:', e);
				}
			};

			const populateBookSelects = () => {
				const selects = document.querySelectorAll('.book-select');
				selects.forEach(select => {
					const currentValue = select.value;
					select.innerHTML = '<option value="">-- Select Book --</option>' +
						allBooks.map(b => `<option value="${b.id}">${escapeHtml(b.title)} (Stock: ${b.stock})</option>`).join('');
					if (currentValue) select.value = currentValue;
				});
			};

			const updateAddBookButton = () => {
				const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
				if (currentCount >= MAX_BOOKS) {
					btnAddBook.disabled = true;
					btnAddBook.textContent = `Maximum ${MAX_BOOKS} books reached`;
				} else {
					btnAddBook.disabled = false;
					btnAddBook.textContent = '+ Add Book';
				}
			};

			const updateRemoveButtons = () => {
				const items = bookItemsContainer.querySelectorAll('.book-item');
				items.forEach(item => {
					const btn = item.querySelector('.btn-remove-book');
					btn.disabled = items.length <= 1;
				});
				updateAddBookButton();
			};

			btnAddBook.addEventListener('click', () => {
				const currentCount = bookItemsContainer.querySelectorAll('.book-item').length;
				if (currentCount >= MAX_BOOKS) {
					alert(`You can only add up to ${MAX_BOOKS} books per rental.`);
					return;
				}
				
				const newItem = document.createElement('div');
				newItem.className = 'book-item row g-2 align-items-end mb-2';
				newItem.innerHTML = `
					<div class="col-md-6">
						<select name="book_id[]" class="form-select book-select" required>
							<option value="">-- Select Book --</option>
						</select>
					</div>
					<div class="col-md-3">
						<input type="number" name="quantity[]" class="form-control" value="1" min="1" placeholder="Qty">
					</div>
					<div class="col-md-3">
						<button type="button" class="btn btn-danger btn-remove-book">Remove</button>
					</div>
				`;
				bookItemsContainer.appendChild(newItem);
				populateBookSelects();
				updateRemoveButtons();
			});

			bookItemsContainer.addEventListener('click', (e) => {
				if (e.target.classList.contains('btn-remove-book')) {
					e.target.closest('.book-item').remove();
					updateRemoveButtons();
				}
			});

			// Create new user API call
			const createNewUser = async () => {
				const name = newUserName.value.trim();
				const email = newUserEmail.value.trim();
				const phone = newUserPhone.value.trim();
				const username = newUserUsername.value.trim();

				if (!name) throw new Error('User name is required');
				if (!email) throw new Error('User email is required');

				const res = await fetch('api/users.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						name: name,
						email: email,
						phone: phone || null,
						username: username || null,
						password: 'password123', // Default password
						role: 'user'
					})
				});

				const data = await res.json();
				if (!res.ok || data.error) {
					throw new Error(data.error || 'Failed to create user');
				}

				return data.data || data;
			};

			form.addEventListener('submit', async (e) => {
				e.preventDefault();

				let userId = userIdInput.value;

				// If creating new user, create them first
				if (isCreatingNewUser) {
					try {
						const newUser = await createNewUser();
						userId = newUser.id;
					} catch (err) {
						alert('Error creating user: ' + err.message);
						return;
					}
				}

				if (!userId) {
					alert('Please select a user or create a new one.');
					userSearchInput.focus();
					return;
				}

				const bookSelects = document.querySelectorAll('.book-select');
				const quantities = document.querySelectorAll('input[name="quantity[]"]');
				const items = [];
				const selectedBookIds = new Set();

				for (let i = 0; i < bookSelects.length; i++) {
					const bookId = bookSelects[i].value;
					const qty = parseInt(quantities[i].value) || 1;
					if (!bookId) {
						alert('Please select a book for all items.');
						return;
					}
					if (selectedBookIds.has(bookId)) {
						alert('Duplicate book selected. Please remove duplicates.');
						return;
					}
					selectedBookIds.add(bookId);
					items.push({ book_id: parseInt(bookId), quantity: qty });
				}

				if (items.length === 0) {
					alert('Please add at least one book.');
					return;
				}

				const dueDate = document.getElementById('dueDate').value;
				if (!dueDate) {
					alert('Please select a due date.');
					return;
				}

				const btn = form.querySelector('button[type="submit"]');
				btn.disabled = true;
				btn.textContent = 'Creating...';

				try {
					const payload = {
						user_id: parseInt(userId),
						items: items,
						due_date: dueDate.replace('T', ' ') + ':00',
						notes: document.getElementById('notes').value.trim() || null
					};

					const res = await fetch('api/rentals.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const data = await res.json();
					if (!res.ok || data.error) {
						throw new Error(data.error || 'Failed to create rental');
					}

					window.location.href = 'index-rental.html?created=1';
				} catch (err) {
					alert(err.message || 'An unexpected error occurred.');
				} finally {
					btn.disabled = false;
					btn.textContent = 'Create Rental';
				}
			});

			// Initialize
			loadUsers();
			loadBooks();
			updateRemoveButtons();
		})();
	</script>
</body>
</html>
