<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Create Rental | Book Management</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="css/style.css">
	<style>
		.book-item {
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 1rem;
			margin-bottom: 1rem;
			background-color: #f8f9fa;
			position: relative;
		}
		.book-item .btn-remove {
			position: absolute;
			top: 0.5rem;
			right: 0.5rem;
		}
		.book-cover-small {
			width: 80px;
			height: 110px;
			object-fit: cover;
			border-radius: 0.25rem;
		}
		#bookSearchModal .book-search-item {
			cursor: pointer;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 0.75rem;
			margin-bottom: 0.5rem;
			transition: all 0.2s;
		}
		#bookSearchModal .book-search-item:hover {
			background-color: #e7f3ff;
			border-color: #0d6efd;
		}
		#bookSearchModal .book-search-item img {
			width: 50px;
			height: 70px;
			object-fit: cover;
		}
		.user-search-container {
			position: relative;
		}
		.user-search-results {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			z-index: 1000;
			max-height: 300px;
			overflow-y: auto;
			background: white;
			border: 1px solid #dee2e6;
			border-top: none;
			border-radius: 0 0 0.375rem 0.375rem;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			display: none;
		}
		.user-search-results.show {
			display: block;
		}
		.user-search-item {
			padding: 0.75rem 1rem;
			cursor: pointer;
			border-bottom: 1px solid #f0f0f0;
		}
		.user-search-item:hover {
			background-color: #f8f9fa;
		}
		.user-search-item:last-child {
			border-bottom: none;
		}
		.user-search-item.create-new {
			background-color: #e7f3ff;
			color: #0d6efd;
			font-weight: 500;
		}
		.user-search-item.create-new:hover {
			background-color: #d0e8ff;
		}
		.selected-user-card {
			background-color: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 1rem;
		}
		.new-user-form {
			background-color: #fff3cd;
			border: 1px solid #ffc107;
			border-radius: 0.375rem;
			padding: 1rem;
		}
		.books-empty-state {
			text-align: center;
			padding: 2rem;
			background-color: #f8f9fa;
			border: 2px dashed #dee2e6;
			border-radius: 0.5rem;
			color: #6c757d;
		}
	</style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
	<div id="navbarInclude" data-include="../include/navbar.html"></div>
	<div class="layout-wrapper">
		<div id="sidebarInclude" data-include="../include/sidebar.html"></div>
		<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
		<main class="content-area">
			<div class="container">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-white border-0 pb-0">
						<h2 class="h4 mb-0">Create new rental</h2>
					</div>
					<div class="card-body">
						<form id="rentalForm" class="row g-3">
							<!-- User Search Section -->
							<div class="col-12">
								<label class="form-label required">User</label>
								<div class="user-search-container">
									<input type="text" id="userSearchInput" class="form-control" placeholder="Search user by name or email..." autocomplete="off">
									<div id="userSearchResults" class="user-search-results"></div>
								</div>
								<input type="hidden" id="userId" name="user_id">
							</div>

							<!-- Selected User Display -->
							<div class="col-12" id="selectedUserContainer" style="display: none;">
								<div class="selected-user-card d-flex justify-content-between align-items-center">
									<div>
										<strong id="selectedUserName"></strong>
										<br>
										<small class="text-muted" id="selectedUserEmail"></small>
									</div>
									<button type="button" class="btn btn-sm btn-outline-danger" id="clearUserBtn">
										<i class="bi bi-x-lg"></i> Change
									</button>
								</div>
							</div>

							<!-- New User Form (hidden by default) -->
							<div class="col-12" id="newUserContainer" style="display: none;">
								<div class="new-user-form">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h6 class="mb-0">
											<i class="bi bi-person-plus me-2"></i>
											Create New User
										</h6>
										<button type="button" class="btn btn-sm btn-outline-secondary" id="cancelNewUserBtn">Cancel</button>
									</div>
									<div class="row g-2">
										<div class="col-md-6">
											<label class="form-label required">Name</label>
											<input type="text" id="newUserName" class="form-control" placeholder="Enter name">
										</div>
										<div class="col-md-6">
											<label class="form-label required">Username</label>
											<input type="text" id="newUserUsername" class="form-control" placeholder="Enter username">
										</div>
										<div class="col-md-6">
											<label class="form-label required">Email</label>
											<input type="email" id="newUserEmail" class="form-control" placeholder="Enter email">
										</div>
										<div class="col-md-6">
											<label class="form-label">Age</label>
											<input type="number" id="newUserAge" class="form-control" placeholder="Enter age" min="1" max="150">
										</div>
										<div class="col-md-6">
											<label class="form-label">Location</label>
											<input type="text" id="newUserLocation" class="form-control" placeholder="e.g., Hanoi, Vietnam">
										</div>
										<div class="col-md-6">
											<label class="form-label">Note</label>
											<input type="text" id="newUserNote" class="form-control" placeholder="Short note...">
										</div>
									</div>
								</div>
							</div>

							<!-- Due Date -->
							<div class="col-md-6">
								<label for="dueDate" class="form-label required">Due Date</label>
								<input type="datetime-local" id="dueDate" class="form-control" required>
							</div>

							<!-- Notes -->
							<div class="col-12">
								<label for="notes" class="form-label">Notes</label>
								<textarea id="notes" rows="2" class="form-control" placeholder="Optional notes..."></textarea>
							</div>

							<!-- Books Section - New Design -->
							<div class="col-12">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<label class="form-label required mb-0">Book Information</label>
									<button type="button" id="btnAddBook" class="btn btn-outline-primary">Add Book</button>
								</div>
								<div id="selectedBooksContainer">
									<div class="books-empty-state" id="booksEmptyState">
										<i class="bi bi-book fs-1 d-block mb-2"></i>
										<p class="mb-0">No books selected. Click "Add Book" to select books for this rental.</p>
									</div>
								</div>
							</div>

							<div class="col-12 d-flex justify-content-end gap-2 pt-3">
								<a href="index-rental.html" class="btn btn-outline-secondary">Cancel</a>
								<button type="submit" class="btn btn-primary">Create Rental</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</main>
	</div>
	<div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

	<!-- Book Search Modal -->
	<div class="modal fade" id="bookSearchModal" tabindex="-1">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Select Book</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<input type="text" id="bookSearchInput" class="form-control" placeholder="Search by title, author, or ISBN...">
					</div>
					<div id="bookSearchResults" style="max-height: 400px; overflow-y: auto;">
						<div class="text-center text-muted py-3">
							<p>Loading books...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="js/layout.js"></script>
	<script>
		(() => {
			document.querySelectorAll('[data-include]').forEach((node) => {
				fetch(node.dataset.include)
					.then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
					.then((html) => { node.innerHTML = html; window.initLayout?.(); })
					.catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
			});
		})();
	</script>
	<script>
		(() => {
			const form = document.getElementById('rentalForm');
			const btnAddBook = document.getElementById('btnAddBook');
			const selectedBooksContainer = document.getElementById('selectedBooksContainer');
			const booksEmptyState = document.getElementById('booksEmptyState');
			const bookSearchModal = new bootstrap.Modal(document.getElementById('bookSearchModal'));
			const bookSearchInput = document.getElementById('bookSearchInput');
			const bookSearchResults = document.getElementById('bookSearchResults');
			
			// User search elements
			const userSearchInput = document.getElementById('userSearchInput');
			const userSearchResults = document.getElementById('userSearchResults');
			const userIdInput = document.getElementById('userId');
			const selectedUserContainer = document.getElementById('selectedUserContainer');
			const selectedUserName = document.getElementById('selectedUserName');
			const selectedUserEmail = document.getElementById('selectedUserEmail');
			const clearUserBtn = document.getElementById('clearUserBtn');
			
			// New user form elements
			const newUserContainer = document.getElementById('newUserContainer');
			const newUserName = document.getElementById('newUserName');
			const newUserUsername = document.getElementById('newUserUsername');
			const newUserEmail = document.getElementById('newUserEmail');
			const newUserAge = document.getElementById('newUserAge');
			const newUserLocation = document.getElementById('newUserLocation');
			const newUserNote = document.getElementById('newUserNote');
			const cancelNewUserBtn = document.getElementById('cancelNewUserBtn');

			const MAX_BOOKS = 5;
			let allBooks = [];
			let allUsers = [];
			let selectedBooks = []; // Array of selected book objects with quantity
			let searchDebounce;
			let isCreatingNewUser = false;

			const escapeHtml = (text) => {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			};

			// Cover image helper - same as update-rental
			const getCoverCandidates = (cover) => {
				const placeholder = 'https://via.placeholder.com/80x110?text=No+Cover';
				const p = window.location.pathname;
				const idx = p.indexOf('/public/');
				const baseRoot = idx !== -1 ? p.substring(0, idx) : '';
				const rootPrefix = window.location.origin + baseRoot;

				if (!cover) return [placeholder];
				const s = String(cover).trim();
				const c = [];
				if (/^https?:\/\//i.test(s)) {
					c.push(s);
				} else if (s.startsWith('//')) {
					c.push(window.location.protocol + s);
				} else {
					const raw = s.replace(/^\/+/, '');
					const patterns = [
						`${rootPrefix}/public/${raw}`,
						`${rootPrefix}/${raw}`,
						`${window.location.origin}/public/${raw}`,
						`${window.location.origin}/${raw}`,
						`${rootPrefix}/public/uploads/books/${raw}`,
						`${rootPrefix}/public/uploads/${raw}`,
						`${rootPrefix}/uploads/books/${raw}`,
						`${rootPrefix}/uploads/${raw}`,
						`${window.location.origin}/uploads/books/${raw}`,
						`${window.location.origin}/uploads/${raw}`,
						`./${raw}`,
						`../${raw}`
					];
					patterns.forEach(u => {
						try {
							c.push(encodeURI(u.replace(/([^:]\/)\/+/g, '$1')));
						} catch (e) {
							c.push(u.replace(/([^:]\/)\/+/g, '$1'));
						}
					});
				}
				c.push(placeholder);
				return Array.from(new Set(c.filter(Boolean)));
			};

			// Image fallback handler
			window.imgFallback = function(img) {
				try {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					let idx = parseInt(img.dataset.srcIdx || '0', 10);
					idx++;
					if (idx < list.length) {
						img.dataset.srcIdx = idx;
						img.src = list[idx];
					} else {
						img.onerror = null;
					}
				} catch (e) {
					img.onerror = null;
				}
			};

			// Initialize images
			const initImages = (root = document) => {
				(root.querySelectorAll ? root.querySelectorAll('img[data-srcs]') : []).forEach(img => {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					if (!list.length) return;
					img.dataset.srcIdx = '0';
					img.src = list[0];
					if (!img.onerror) img.onerror = function(){ window.imgFallback(this); };
				});
			};

			// Vietnam timezone helper
			const getVietnamDateTimeLocal = (addDays = 0) => {
				const now = new Date();
				const vnOptions = { 
					timeZone: 'Asia/Ho_Chi_Minh', 
					year: 'numeric', 
					month: '2-digit', 
					day: '2-digit', 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: false 
				};
				const parts = new Intl.DateTimeFormat('en-CA', vnOptions).formatToParts(now);
				
				let year = '', month = '', day = '', hour = '', minute = '';
				parts.forEach(p => {
					if (p.type === 'year') year = p.value;
					if (p.type === 'month') month = p.value;
					if (p.type === 'day') day = p.value;
					if (p.type === 'hour') hour = p.value;
					if (p.type === 'minute') minute = p.value;
				});
				
				let vnDate = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
				if (addDays > 0) {
					vnDate.setDate(vnDate.getDate() + addDays);
				}
				
				const y = vnDate.getFullYear();
				const m = String(vnDate.getMonth() + 1).padStart(2, '0');
				const d = String(vnDate.getDate()).padStart(2, '0');
				const h = String(vnDate.getHours()).padStart(2, '0');
				const min = String(vnDate.getMinutes()).padStart(2, '0');
				
				return `${y}-${m}-${d}T${h}:${min}`;
			};

			// Format datetime for display - Vietnam timezone
			const formatDateTimeDisplay = (dateStr) => {
				if (!dateStr) return '-';
				const d = new Date(dateStr);
				return d.toLocaleString('vi-VN', { 
					hour: '2-digit', 
					minute: '2-digit',
					day: '2-digit', 
					month: '2-digit', 
					year: 'numeric',
					timeZone: 'Asia/Ho_Chi_Minh'
				});
			};

			// Get current datetime for start date
			const getCurrentDateTime = () => {
				const now = new Date();
				const vnOptions = { 
					timeZone: 'Asia/Ho_Chi_Minh', 
					year: 'numeric', 
					month: '2-digit', 
					day: '2-digit', 
					hour: '2-digit', 
					minute: '2-digit',
					hour12: false 
				};
				const parts = new Intl.DateTimeFormat('en-CA', vnOptions).formatToParts(now);
				let year = '', month = '', day = '', hour = '', minute = '';
				parts.forEach(p => {
					if (p.type === 'year') year = p.value;
					if (p.type === 'month') month = p.value;
					if (p.type === 'day') day = p.value;
					if (p.type === 'hour') hour = p.value;
					if (p.type === 'minute') minute = p.value;
				});
				return `${year}-${month}-${day} ${hour}:${minute}:00`;
			};

			// Set default due date (14 days from now)
			document.getElementById('dueDate').value = getVietnamDateTimeLocal(14);

			// ==================== USER SEARCH ====================
			const loadUsers = async () => {
				try {
					const res = await fetch('api/users.php?per_page=10000');
					const data = await res.json();
					allUsers = (data.data || data || []).filter(u => !u.deleted_at);
				} catch (e) {
					console.error('Error loading users:', e);
					allUsers = [];
				}
			};

			const searchUsers = (query) => {
				const q = query.toLowerCase().trim();
				if (!q) return allUsers.slice(0, 10);
				return allUsers.filter(u => 
					(u.name && u.name.toLowerCase().includes(q)) ||
					(u.email && u.email.toLowerCase().includes(q)) ||
					(u.username && u.username.toLowerCase().includes(q))
				).slice(0, 10);
			};

			const renderSearchResults = (users, query) => {
				let html = '';
				if (users.length > 0) {
					html = users.map(u => `
						<div class="user-search-item" data-user-id="${u.id}" data-name="${escapeHtml(u.name)}" data-email="${escapeHtml(u.email)}">
							<strong>${escapeHtml(u.name)}</strong><br>
							<small class="text-muted">${escapeHtml(u.email)}</small>
						</div>
					`).join('');
				}
				if (query.trim()) {
					html += `
						<div class="user-search-item create-new" data-action="create-new">
							<i class="bi bi-person-plus me-2"></i>
							Create new user "${escapeHtml(query)}"
						</div>
					`;
				} else if (users.length === 0) {
					html = `<div class="user-search-item text-muted" style="cursor: default;">No users found.</div>`;
				}
				userSearchResults.innerHTML = html;
				userSearchResults.classList.add('show');
				
				userSearchResults.querySelectorAll('.user-search-item[data-user-id]').forEach(item => {
					item.addEventListener('click', () => selectUser(item.dataset.userId, item.dataset.name, item.dataset.email));
				});
				userSearchResults.querySelector('.user-search-item[data-action="create-new"]')?.addEventListener('click', () => {
					showNewUserForm(query);
				});
			};

			const selectUser = (userId, name, email) => {
				userIdInput.value = userId;
				selectedUserName.textContent = name;
				selectedUserEmail.textContent = email;
				userSearchInput.style.display = 'none';
				userSearchResults.classList.remove('show');
				selectedUserContainer.style.display = 'block';
				newUserContainer.style.display = 'none';
				isCreatingNewUser = false;
			};

			const showNewUserForm = (searchQuery) => {
				userSearchInput.style.display = 'none';
				userSearchResults.classList.remove('show');
				selectedUserContainer.style.display = 'none';
				newUserContainer.style.display = 'block';
				isCreatingNewUser = true;
				if (searchQuery.includes('@')) {
					newUserEmail.value = searchQuery;
					newUserName.value = '';
				} else {
					newUserName.value = searchQuery;
					newUserEmail.value = '';
				}
				userIdInput.value = '';
				newUserName.focus();
			};

			const clearUserSelection = () => {
				userIdInput.value = '';
				userSearchInput.value = '';
				userSearchInput.style.display = 'block';
				selectedUserContainer.style.display = 'none';
				newUserContainer.style.display = 'none';
				isCreatingNewUser = false;
				newUserName.value = '';
				newUserUsername.value = '';
				newUserEmail.value = '';
				newUserAge.value = '';
				newUserLocation.value = '';
				newUserNote.value = '';
				userSearchInput.focus();
			};

			userSearchInput.addEventListener('input', (e) => {
				clearTimeout(searchDebounce);
				searchDebounce = setTimeout(() => {
					const results = searchUsers(e.target.value);
					renderSearchResults(results, e.target.value);
				}, 200);
			});

			userSearchInput.addEventListener('focus', () => {
				const results = searchUsers(userSearchInput.value);
				renderSearchResults(results, userSearchInput.value);
			});

			document.addEventListener('click', (e) => {
				if (!e.target.closest('.user-search-container')) {
					userSearchResults.classList.remove('show');
				}
			});

			clearUserBtn.addEventListener('click', clearUserSelection);
			cancelNewUserBtn.addEventListener('click', clearUserSelection);

			// ==================== BOOK SELECTION ====================
			const loadBooks = async () => {
				try {
					const res = await fetch('api/db.php?limit=10000');
					const data = await res.json();
					const books = data.data || data || [];
					allBooks = books.filter(b => !b.deleted_at && Number(b.is_rental) === 1 && Number(b.stock) > 0);
					console.log('Loaded books:', allBooks.length);
				} catch (e) {
					console.error('Error loading books:', e);
					allBooks = [];
				}
			};

			const renderBookSearchResults = (books) => {
				if (books.length === 0) {
					bookSearchResults.innerHTML = '<div class="text-center text-muted py-3">No books found.</div>';
					return;
				}
				bookSearchResults.innerHTML = books.map(book => {
					const isAlreadySelected = selectedBooks.some(b => b.id === book.id);
					const disabledClass = isAlreadySelected ? 'opacity-50' : '';
					const disabledAttr = isAlreadySelected ? 'style="pointer-events:none;"' : '';
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(u => escapeHtml(u)).join('||');
					return `
						<div class="book-search-item d-flex align-items-center ${disabledClass}" data-book-id="${book.id}" ${disabledAttr}>
							<img src="${escapeHtml(coverCandidates[0])}" 
								 data-srcs="${dataSrcs}"
								 onerror="window.imgFallback(this)" 
								 alt="${escapeHtml(book.title)}" class="me-3">
							<div class="flex-grow-1">
								<h6 class="mb-1">${escapeHtml(book.title)}</h6>
								<div class="small text-muted">
									${escapeHtml(book.author || 'Unknown')} â€¢ ${escapeHtml(book.isbn || 'N/A')}
								</div>
							</div>
							${isAlreadySelected ? '<span class="badge bg-secondary">Selected</span>' : ''}
						</div>
					`;
				}).join('');

				initImages(bookSearchResults);

				// Attach click handlers
				bookSearchResults.querySelectorAll('.book-search-item:not(.opacity-50)').forEach(item => {
					item.addEventListener('click', () => {
						const bookId = parseInt(item.dataset.bookId);
						addBookToSelection(bookId);
					});
				});
			};

			const addBookToSelection = (bookId) => {
				const book = allBooks.find(b => b.id === bookId);
				if (!book) return;
				if (selectedBooks.some(b => b.id === bookId)) {
					alert('This book is already selected.');
					return;
				}
				if (selectedBooks.length >= MAX_BOOKS) {
					alert(`Maximum ${MAX_BOOKS} books allowed per rental.`);
					return;
				}
				
				// Get current start time and due date
				const startDate = getCurrentDateTime();
				const dueDate = document.getElementById('dueDate').value;
				const endDate = dueDate ? dueDate.replace('T', ' ') + ':00' : null;
				
				selectedBooks.push({ 
					...book, 
					quantity: 1,
					start_date: startDate,
					end_date: endDate
				});
				renderSelectedBooks();
				bookSearchModal.hide();
				updateAddBookButton();
			};

			const removeBookFromSelection = (bookId) => {
				selectedBooks = selectedBooks.filter(b => b.id !== bookId);
				renderSelectedBooks();
				updateAddBookButton();
			};

			const updateBookQuantity = (bookId, quantity) => {
				const book = selectedBooks.find(b => b.id === bookId);
				if (book) {
					book.quantity = Math.max(1, Math.min(quantity, book.stock));
					renderSelectedBooks();
				}
			};

			const renderSelectedBooks = () => {
				if (selectedBooks.length === 0) {
					booksEmptyState.style.display = 'block';
					const cards = selectedBooksContainer.querySelectorAll('.book-item');
					cards.forEach(c => c.remove());
					return;
				}
				booksEmptyState.style.display = 'none';

				// Update end_date for all books when due date changes
				const dueDate = document.getElementById('dueDate').value;
				const endDate = dueDate ? dueDate.replace('T', ' ') + ':00' : null;
				selectedBooks.forEach(book => {
					book.end_date = endDate;
				});

				const canRemove = selectedBooks.length > 1;

				let html = '';
				selectedBooks.forEach((book, idx) => {
					const qty = book.quantity ?? 1;
					const start = book.start_date ? formatDateTimeDisplay(book.start_date) : '-';
					const end = book.end_date ? formatDateTimeDisplay(book.end_date) : '-';
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(u => escapeHtml(u)).join('||');
					
					html += `
						<div class="book-item" data-book-id="${book.id}" data-book-idx="${idx}">
							<button type="button" class="btn btn-sm btn-danger btn-remove" data-book-id="${book.id}" ${!canRemove ? 'disabled title="Cannot remove - minimum 1 book required"' : ''}>
								<i class="bi bi-trash"></i> Remove
							</button>
							<div class="row align-items-start">
								<div class="col-auto">
									<img src="${escapeHtml(coverCandidates[0])}" 
										 width="80" height="110" loading="lazy" decoding="async"
										 data-srcs="${dataSrcs}" 
										 data-src-idx="0"
										 onerror="window.imgFallback(this)" 
										 alt="${escapeHtml(book.title || '')}" 
										 class="book-cover-small" 
										 style="border: 1px solid #dee2e6;">
								</div>
								<div class="col">
									<h6 class="mb-1">${escapeHtml(book.title || 'N/A')}</h6>
									<div class="small text-muted">
										<div><strong>ISBN:</strong> ${escapeHtml(book.isbn || 'N/A')}</div>
										<div><strong>Author:</strong> ${escapeHtml(book.author || 'N/A')}</div>
										<div><strong>Quantity:</strong> ${qty}</div>
										<div><strong>Start:</strong> ${start}</div>
										<div><strong>End:</strong> ${end}</div>
									</div>
								</div>
							</div>
						</div>
					`;
				});
				
				// Remove existing cards and add new ones
				const existingCards = selectedBooksContainer.querySelectorAll('.book-item');
				existingCards.forEach(c => c.remove());
				booksEmptyState.insertAdjacentHTML('beforebegin', html);

				// Attach remove button handlers
				selectedBooksContainer.querySelectorAll('.btn-remove').forEach(btn => {
					btn.addEventListener('click', (e) => {
						e.preventDefault();
						const bookId = parseInt(btn.dataset.bookId);
						if (selectedBooks.length <= 1) {
							alert('Cannot remove - at least 1 book is required for a rental.');
							return;
						}
						if (confirm('Remove this book from the rental?')) {
							removeBookFromSelection(bookId);
						}
					});
				});

				initImages(selectedBooksContainer);
			};

			// Update end_date when due date changes
			document.getElementById('dueDate').addEventListener('change', () => {
				if (selectedBooks.length > 0) {
					renderSelectedBooks();
				}
			});

			const updateAddBookButton = () => {
				if (selectedBooks.length >= MAX_BOOKS) {
					btnAddBook.disabled = true;
					btnAddBook.textContent = `Maximum ${MAX_BOOKS} books`;
				} else {
					btnAddBook.disabled = false;
					btnAddBook.textContent = 'Add Book';
				}
			};

			// Open book search modal
			btnAddBook.addEventListener('click', () => {
				if (selectedBooks.length >= MAX_BOOKS) {
					alert(`Maximum ${MAX_BOOKS} books allowed per rental.`);
					return;
				}
				bookSearchInput.value = '';
				renderBookSearchResults(allBooks);
				bookSearchModal.show();
				setTimeout(() => bookSearchInput.focus(), 300);
			});

			// Book search input
			bookSearchInput.addEventListener('input', (e) => {
				const query = e.target.value.toLowerCase().trim();
				const filtered = query 
					? allBooks.filter(b => 
						b.title?.toLowerCase().includes(query) ||
						b.author?.toLowerCase().includes(query) ||
						b.isbn?.toLowerCase().includes(query)
					)
					: allBooks;
				renderBookSearchResults(filtered);
			});

			// ==================== FORM SUBMIT ====================
			const createNewUser = async () => {
				const name = newUserName.value.trim();
				const username = newUserUsername.value.trim();
				const email = newUserEmail.value.trim();
				const age = newUserAge.value ? parseInt(newUserAge.value) : null;
				const location = newUserLocation.value.trim();
				const note = newUserNote.value.trim();

				if (!name) throw new Error('User name is required');
				if (!username) throw new Error('Username is required');
				if (!email) throw new Error('User email is required');

				const res = await fetch('api/users.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name, username, email, age, location: location || null, note: note || null })
				});
				const data = await res.json();
				if (!res.ok || data.error) throw new Error(data.error || 'Failed to create user');
				return data.data || data;
			};

			form.addEventListener('submit', async (e) => {
				e.preventDefault();

				let userId = userIdInput.value;

				if (isCreatingNewUser) {
					try {
						const newUser = await createNewUser();
						userId = newUser.id;
					} catch (err) {
						alert('Error creating user: ' + err.message);
						return;
					}
				}

				if (!userId) {
					alert('Please select a user or create a new one.');
					userSearchInput.focus();
					return;
				}

				if (selectedBooks.length === 0) {
					alert('Please add at least one book.');
					return;
				}

				const dueDate = document.getElementById('dueDate').value;
				if (!dueDate) {
					alert('Please select a due date.');
					return;
				}

				const btn = form.querySelector('button[type="submit"]');
				btn.disabled = true;
				btn.textContent = 'Creating...';

				try {
					const items = selectedBooks.map(b => ({
						book_id: b.id,
						quantity: b.quantity,
						start_date: b.start_date,
						end_date: b.end_date
					}));

					const payload = {
						user_id: parseInt(userId),
						items: items,
						due_date: dueDate.replace('T', ' ') + ':00',
						notes: document.getElementById('notes').value.trim() || null
					};

					const res = await fetch('api/rentals.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const data = await res.json();
					if (!res.ok || data.error) {
						throw new Error(data.error || 'Failed to create rental');
					}

					window.location.href = 'index-rental.html?created=1';
				} catch (err) {
					alert(err.message || 'An unexpected error occurred.');
				} finally {
					btn.disabled = false;
					btn.textContent = 'Create Rental';
				}
			});

			// ==================== INITIALIZE ====================
			loadUsers();
			loadBooks();
			updateAddBookButton();
		})();
	</script>
</body>
</html>
