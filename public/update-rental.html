<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Edit Rental | Book Management</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="css/style.css">
	<style>
		.book-item {
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 1rem;
			margin-bottom: 1rem;
			background-color: #f8f9fa;
			position: relative;
		}
		.book-item .btn-remove {
			position: absolute;
			top: 0.5rem;
			right: 0.5rem;
		}
		.book-cover-small {
			width: 80px;
			height: 110px;
			object-fit: cover;
			border-radius: 0.25rem;
		}
		#bookSearchModal .book-search-item {
			cursor: pointer;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 0.75rem;
			margin-bottom: 0.5rem;
			transition: all 0.2s;
		}
		#bookSearchModal .book-search-item:hover {
			background-color: #f8f9fa;
			border-color: #0d6efd;
		}
		#bookSearchModal .book-search-item img {
			width: 50px;
			height: 70px;
			object-fit: cover;
		}
		#userSearchModal .book-search-item {
			cursor: pointer;
			border: 1px solid #dee2e6;
			border-radius: 0.375rem;
			padding: 0.75rem;
			margin-bottom: 0.5rem;
			transition: all 0.2s;
		}
		#userSearchModal .book-search-item:hover {
			background-color: #f8f9fa;
			border-color: #0d6efd;
		}
	</style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
	<div id="navbarInclude" data-include="../include/navbar.html"></div>
	<div class="layout-wrapper">
		<div id="sidebarInclude" data-include="../include/sidebar.html"></div>
		<div class="sidebar-backdrop" id="sidebarBackdrop"></div>
		<main class="content-area">
			<div class="container">
				<div class="card shadow-sm border-0">
					<div class="card-header bg-white border-0 pb-0">
						<h2 class="h4 mb-0">Edit rental</h2>
					</div>
					<div class="card-body">
						<form id="rentalUpdateForm" class="row g-3">
							<input type="hidden" id="rentalId">
							
							<!-- User Information -->
							<div class="col-12">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h5 class="text-primary mb-0">User Information</h5>
									<button type="button" class="btn btn-sm btn-outline-primary" id="changeUserBtn">
										<i class="bi bi-person-plus"></i> Change User
									</button>
								</div>
							</div>
							<div class="col-md-6">
								<label class="form-label">User Name</label>
								<input type="text" id="userName" class="form-control" readonly>
								<input type="hidden" id="userId">
							</div>
							<div class="col-md-6">
								<label class="form-label">User Email</label>
								<input type="text" id="userEmail" class="form-control" readonly>
							</div>

							<!-- Book Information -->
							<div class="col-12 mt-4">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h5 class="text-primary mb-0">Book Information</h5>
									<button type="button" class="btn btn-sm btn-outline-primary" id="addBookBtn">
										<i class="bi bi-plus-circle"></i> Add Book
									</button>
								</div>
							</div>
							<div class="col-12">
								<div id="booksList">
									<!-- Books will be loaded here -->
								</div>
							</div>

							<!-- Rental Details -->
							<div class="col-12 mt-4">
								<h5 class="text-primary mb-3">Rental Details</h5>
							</div>
							<div class="col-md-6">
								<label for="rentalDate" class="form-label">Rental Date</label>
								<input type="text" id="rentalDate" class="form-control" readonly>
							</div>
							<div class="col-md-6">
								<label for="dueDate" class="form-label required">Due Date</label>
								<input type="datetime-local" id="dueDate" class="form-control" required>
							</div>
							<div class="col-md-6">
								<label for="returnDate" class="form-label">Return Date</label>
								<input type="datetime-local" id="returnDate" class="form-control">
								<div class="form-text">Leave empty if not returned yet</div>
							</div>
							<div class="col-md-6">
								<label for="status" class="form-label required">Status</label>
								<select id="status" class="form-select" required>
									<option value="active">Active</option>
									<option value="returned">Returned</option>
									<option value="overdue">Overdue</option>
								</select>
							</div>
							<div class="col-12">
								<label for="notes" class="form-label">Notes</label>
								<textarea id="notes" rows="3" class="form-control" placeholder="Optional notes..."></textarea>
							</div>

							<div class="col-12 d-flex justify-content-end gap-2 pt-3">
								<a href="index-rental.html" class="btn btn-outline-secondary">Cancel</a>
								<button type="submit" class="btn btn-primary">Update rental</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</main>
	</div>
	<div id="footerInclude" class="layout-footer" data-include="../include/footer.html"></div>

	<!-- Book Search Modal -->
	<div class="modal fade" id="bookSearchModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Select Book</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<input type="text" id="bookSearchInput" class="form-control" placeholder="Search by title, author, or ISBN...">
					</div>
					<div id="bookSearchResults" style="max-height: 400px; overflow-y: auto;">
						<div class="text-center text-muted py-3">
							<p>Type to search for books...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- User Search Modal -->
	<div class="modal fade" id="userSearchModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Select User</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<input type="text" id="userSearchInput" class="form-control" placeholder="Search by name, username, or email...">
					</div>
					<div id="userSearchResults" style="max-height: 400px; overflow-y: auto;">
						<div class="text-center text-muted py-3">
							<p>Type to search for users...</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="js/layout.js"></script>
	<script>
		document.querySelectorAll('[data-include]').forEach((node) => {
			fetch(node.dataset.include)
				.then((res) => (res.ok ? res.text() : Promise.reject(res.statusText)))
				.then((html) => { node.innerHTML = html; window.initLayout?.(); })
				.catch(() => { node.innerHTML = '<div class="alert alert-warning m-0">Unable to load layout section.</div>'; });
		});
	</script>
	<script>
		(() => {
			const form = document.getElementById('rentalUpdateForm');
			const params = new URLSearchParams(window.location.search);
			const id = params.get('id');
			const booksList = document.getElementById('booksList');
			let rentalBooks = [];
			let allBooks = [];
			let allUsers = [];
			const bookSearchModal = new bootstrap.Modal(document.getElementById('bookSearchModal'));
			const userSearchModal = new bootstrap.Modal(document.getElementById('userSearchModal'));

			if (!id) {
				form.innerHTML = '<div class="alert alert-warning mb-0">Missing rental id.</div>';
				return;
			}

			// Escape HTML
			const escapeHtml = (text) => {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			};

			// Resolve cover image URL with sensible fallbacks (returns absolute URLs)
			const getCoverCandidates = (cover) => {
				const placeholder = 'https://via.placeholder.com/80x110?text=No+Cover';
				// compute project base (remove '/public/...' from path)
				const p = window.location.pathname;
				const idx = p.indexOf('/public/');
				const baseRoot = idx !== -1 ? p.substring(0, idx) : '';
				const rootPrefix = window.location.origin + baseRoot; // e.g. https://localhost/book_management

				if (!cover) return [placeholder];
				const s = String(cover).trim();
				const c = [];
				if (/^https?:\/\//i.test(s)) {
					c.push(s);
				} else if (s.startsWith('/')) {
					// absolute from domain root
					c.push(window.location.origin + s);
					c.push(window.location.origin + '/' + s.replace(/^\/+/, ''));
				} else {
					// try uploads under project root and public-relative paths
					c.push(rootPrefix + '/uploads/books/' + s);
					c.push(rootPrefix + '/uploads/' + s);
					// also try public-relative (current location) fallbacks
					c.push('./uploads/books/' + s);
					c.push('../uploads/books/' + s);
					c.push('./uploads/' + s);
					c.push('../uploads/' + s);
				}
				c.push(placeholder);
				return c;
			};

			// onerror handler to try next candidate
			window.imgFallback = function(img) {
				try {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					let idx = parseInt(img.dataset.srcIdx || '0', 10);
					idx++;
					if (idx < list.length) {
						img.dataset.srcIdx = idx;
						img.src = list[idx];
					} else {
						img.onerror = null;
					}
				} catch (e) {
					img.onerror = null;
				}
			};

			// initialize imgs that have data-srcs after rendering
			const initImages = (root = document) => {
				(root.querySelectorAll ? root.querySelectorAll('img[data-srcs]') : []).forEach(img => {
					const list = (img.dataset.srcs || '').split('||').filter(Boolean);
					if (!list.length) return;
					// set initial index and src to first candidate if not already set
					img.dataset.srcIdx = img.dataset.srcIdx || '0';
					try { img.src = list[0]; } catch(e){ /*ignore*/ }
					// attach onerror if not present
					if (!img.onerror) img.onerror = function(){ window.imgFallback(this); };
					// debug
					console.debug('img candidates', img, list);
				});
			};

			// Format datetime for input[type="datetime-local"]
			const formatDateTimeLocal = (dateStr) => {
				if (!dateStr) return '';
				const d = new Date(dateStr);
				const year = d.getFullYear();
				const month = String(d.getMonth() + 1).padStart(2, '0');
				const day = String(d.getDate()).padStart(2, '0');
				const hours = String(d.getHours()).padStart(2, '0');
				const minutes = String(d.getMinutes()).padStart(2, '0');
				return `${year}-${month}-${day}T${hours}:${minutes}`;
			};

			// Format datetime for display
			const formatDateTimeDisplay = (dateStr) => {
				if (!dateStr) return '-';
				const d = new Date(dateStr);
				return d.toLocaleString('vi-VN', { 
					year: 'numeric', 
					month: '2-digit', 
					day: '2-digit', 
					hour: '2-digit', 
					minute: '2-digit' 
				});
			};

			// Load all books for search
			fetch('api/db.php')
				.then(res => res.json())
				.then(data => {
					if (data.success && data.data) {
						allBooks = data.data;
					}
				})
				.catch(() => {});

			// Load all users for search
			fetch('api/users.php?per_page=1000')
				.then(res => res.json())
				.then(data => {
					if (data.data) {
						allUsers = data.data;
					}
				})
				.catch(() => {});

			// Render books list (show quantity, dates). Allow remove only for newly added items (no rental_item id)
			const renderBooksList = () => {
				if (rentalBooks.length === 0) {
					booksList.innerHTML = '<div class="alert alert-info mb-0">No book selected. Click "Add Book" to select a book for this rental.</div>';
					return;
				}

				booksList.innerHTML = rentalBooks.map(book => {
					const qty = book.quantity ?? 1;
					const start = book.start_date ? formatDateTimeDisplay(book.start_date) : '-';
					const end = book.end_date ? formatDateTimeDisplay(book.end_date) : '-';
					const isExisting = !!book.rental_item_id || !!book.rental_id;
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(escapeHtml).join('||');
					const src0 = escapeHtml(coverCandidates[0]);
					return `
						<div class="book-item" data-book-id="${book.id}" data-rental-item-id="${book.rental_item_id || ''}">
							<button type="button" class="btn btn-sm ${isExisting ? 'btn-secondary' : 'btn-danger'} btn-remove" ${isExisting ? 'disabled title="Existing item cannot be removed here"' : `onclick="removeBook(${book.id}, ${book.rental_id || 'null'})"`}>
								<i class="bi bi-trash"></i> ${isExisting ? 'Existing' : 'Remove'}
							</button>
							<div class="row align-items-center">
								<div class="col-auto">
									<img src="${src0}" data-srcs="${dataSrcs}" data-src-idx="0" onerror="window.imgFallback(this)" alt="${escapeHtml(book.title || '')}" class="book-cover-small">
								</div>
								<div class="col">
									<h6 class="mb-1">${escapeHtml(book.title || 'N/A')}</h6>
									<div class="small text-muted">
										<div><strong>ISBN:</strong> ${escapeHtml(book.isbn || 'N/A')}</div>
										<div><strong>Author:</strong> ${escapeHtml(book.author || 'N/A')}</div>
										<div><strong>Quantity:</strong> ${qty}</div>
										<div><strong>Start:</strong> ${start}</div>
										<div><strong>End:</strong> ${end}</div>
									</div>
								</div>
							</div>
						</div>
					`;
				}).join('');
				initImages(booksList);
			};

			// Add book to list (now: if editing existing rental, call API to add item)
			window.addBookToRental = async (bookId) => {
				const book = allBooks.find(b => b.id === bookId);
				if (!book) return;

				// Check if already added locally
				if (rentalBooks.some(b => b.id === bookId && !b._deleted)) {
					alert('This book is already selected for the rental.');
					return;
				}
				if (Number(book.is_rental) !== 1) { alert('This book is not available for rental.'); return; }
				if (Number(book.stock) <= 0) { alert('This book is out of stock.'); return; }

				const currentRentalId = Number(document.querySelector('#rentalId').value || 0);
				const dueDateVal = document.querySelector('#dueDate')?.value;
				const endDate = dueDateVal ? dueDateVal.replace('T', ' ') + ':00' : null;

				// If editing an existing rental -> call API to add item
				if (currentRentalId) {
					try {
						const res = await fetch('api/rentals.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'add_item',
								rental_id: currentRentalId,
								book_id: bookId,
								quantity: 1,
								start_date: null,
								end_date: endDate
							})
						});
						const data = await res.json();
						if (!res.ok || data?.error) throw new Error(data?.error || 'Failed to add item');
						// push returned item
						const item = data.data ?? data;
						// normalize book view
						rentalBooks.push({
							id: item.book_id,
							title: item.book_title || book.title,
							isbn: item.book_isbn || book.isbn,
							author: item.book_author || book.author,
							cover_image: book.cover_image || null,
							quantity: item.quantity ?? 1,
							start_date: item.start_date,
							end_date: item.end_date,
							rental_id: item.rental_id,
							rental_item_id: item.id,
						});
						renderBooksList();
						bookSearchModal.hide();
					} catch (err) {
						alert(err.message || 'Unable to add book to rental.');
					}
					return;
				}

				// If creating new (no rental id yet), just push locally
				rentalBooks.push({ ...book, rental_id: null, quantity: 1 });
				renderBooksList();
				bookSearchModal.hide();
			};

			// Remove book from list (if item exists on server, call DELETE)
			window.removeBook = async (bookId, rentalId) => {
				if (!confirm('Are you sure you want to remove this book from the rental?')) return;

				// find local item
				const idx = rentalBooks.findIndex(b => b.id === bookId && (b.rental_id === rentalId || !rentalId));
				if (idx === -1) return;

				const item = rentalBooks[idx];
				// If item exists on server (has rental_item_id) -> delete via API
				if (item.rental_item_id) {
					try {
						const res = await fetch('api/rentals.php', {
							method: 'DELETE',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ item_id: item.rental_item_id })
						});
						const data = await res.json();
						if (!res.ok || data?.error) throw new Error(data?.error || 'Failed to delete item');
						// remove locally
						rentalBooks.splice(idx, 1);
						renderBooksList();
					} catch (err) {
						alert(err.message || 'Unable to remove book from rental.');
					}
					return;
				}

				// Otherwise simply remove locally
				rentalBooks.splice(idx, 1);
				renderBooksList();
			};

			// Render books in search modal
			const renderBookSearchResults = (books) => {
				if (books.length === 0) {
					bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No books found.</p></div>';
					return;
				}

				bookSearchResults.innerHTML = books.map(book => {
					const coverCandidates = getCoverCandidates(book.cover_image);
					const dataSrcs = coverCandidates.map(escapeHtml).join('||');
					const src0 = escapeHtml(coverCandidates[0]);
					return `
						<div class="book-search-item d-flex align-items-center" onclick="addBookToRental(${book.id})">
							<img src="${src0}" data-srcs="${dataSrcs}" onerror="window.imgFallback(this)" alt="${escapeHtml(book.title || '')}" class="me-3">
							<div class="flex-grow-1">
								<h6 class="mb-1">${escapeHtml(book.title || 'Unknown')}</h6>
								<div class="small text-muted">
									${escapeHtml(book.author || 'Unknown Author')} • ${escapeHtml(book.isbn || 'No ISBN')}
								</div>
							</div>
						</div>
					`;
				}).join('');
				initImages(bookSearchResults);
			};

			// Book search functionality
			const bookSearchInput = document.getElementById('bookSearchInput');
			const bookSearchResults = document.getElementById('bookSearchResults');

			bookSearchInput.addEventListener('input', (e) => {
				const query = e.target.value.toLowerCase().trim();
				
				let filtered;
				if (query.length === 0) {
					// Show all books when query is empty
					filtered = allBooks;
				} else {
					filtered = allBooks.filter(book => {
						return (book.title?.toLowerCase().includes(query) ||
								book.author?.toLowerCase().includes(query) ||
								book.isbn?.toLowerCase().includes(query));
					});
				}

				renderBookSearchResults(filtered);
			});

			// Show add book modal
			document.getElementById('addBookBtn').addEventListener('click', () => {
				bookSearchInput.value = '';
				// Show all books when modal opens (if loaded)
				if (allBooks.length > 0) {
					renderBookSearchResults(allBooks);
				} else {
					bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Loading books...</p></div>';
					// Try to load books if not loaded yet
					fetch('api/db.php')
						.then(res => res.json())
						.then(data => {
							if (data.success && data.data) {
								allBooks = data.data;
								renderBookSearchResults(allBooks);
							} else {
								bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No books available.</p></div>';
							}
						})
						.catch(() => {
							bookSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Error loading books.</p></div>';
						});
				}
				bookSearchModal.show();
			});

			// Select user function
			const selectUser = (userId, userName, userEmail) => {
				document.getElementById('userId').value = userId;
				document.getElementById('userName').value = userName;
				document.getElementById('userEmail').value = userEmail;
				userSearchModal.hide();
			};
			window.selectUser = selectUser; // Make it global for compatibility

			// Render users in search modal
			const renderUserSearchResults = (users) => {
				if (users.length === 0) {
					userSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No users found.</p></div>';
					return;
				}

				// Clear previous results
				userSearchResults.innerHTML = '';
				
				// Create and append user items with event listeners
				users.forEach(user => {
					const userId = user.id;
					const userName = user.name || '';
					const userEmail = user.email || '';
					const userNameEscaped = escapeHtml(userName);
					const userEmailEscaped = escapeHtml(userEmail);
					const usernameEscaped = escapeHtml(user.username || 'No username');
					
					const item = document.createElement('div');
					item.className = 'book-search-item d-flex align-items-center';
					item.style.cursor = 'pointer';
					item.innerHTML = `
						<div class="flex-grow-1">
							<h6 class="mb-1">${userNameEscaped || 'Unknown'}</h6>
							<div class="small text-muted">
								${usernameEscaped} • ${userEmailEscaped || 'No email'}
							</div>
						</div>
					`;
					
					// Add click event
					item.addEventListener('click', () => {
						selectUser(userId, userName, userEmail);
					});
					
					userSearchResults.appendChild(item);
				});
			};

			// User search functionality
			const userSearchInput = document.getElementById('userSearchInput');
			const userSearchResults = document.getElementById('userSearchResults');

			userSearchInput.addEventListener('input', (e) => {
				const query = e.target.value.toLowerCase().trim();
				
				let filtered;
				if (query.length === 0) {
					// Show all users when query is empty
					filtered = allUsers;
				} else {
					filtered = allUsers.filter(user => {
						return (user.name?.toLowerCase().includes(query) ||
								user.username?.toLowerCase().includes(query) ||
								user.email?.toLowerCase().includes(query));
					});
				}

				renderUserSearchResults(filtered);
			});

			// Show change user modal
			const changeUserBtn = document.getElementById('changeUserBtn');
			if (changeUserBtn) {
				changeUserBtn.addEventListener('click', () => {
					if (!userSearchInput || !userSearchResults || !userSearchModal) {
						alert('User search modal is not available.');
						return;
					}
					userSearchInput.value = '';
					// Show all users when modal opens (if loaded)
					if (allUsers.length > 0) {
						renderUserSearchResults(allUsers);
					} else {
						userSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Loading users...</p></div>';
						// Try to load users if not loaded yet
						fetch('api/users.php?per_page=1000')
							.then(res => res.json())
							.then(data => {
								if (data.data) {
									allUsers = data.data;
									renderUserSearchResults(allUsers);
								} else {
									userSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>No users available.</p></div>';
								}
							})
							.catch(() => {
								userSearchResults.innerHTML = '<div class="text-center text-muted py-3"><p>Error loading users.</p></div>';
							});
					}
					userSearchModal.show();
				});
			}

			// Load rental data (use rental.items)
			fetch(`api/rentals.php?id=${encodeURIComponent(id)}`)
				.then((res) => res.json().then((data) => ({ ok: res.ok, data })))
				.then(({ ok, data }) => {
					if (!ok || data?.error || !data?.data) throw new Error(data?.error ?? 'Rental not found.');
					const rental = data.data;

					// Check if rental is already returned
					if (rental.status === 'returned') {
						form.innerHTML = `
							<div class="alert alert-warning mb-0">
								<h5 class="alert-heading">Cannot Edit Returned Rental</h5>
								<p class="mb-0">This rental has already been returned and cannot be edited.</p>
								<hr>
								<div class="d-flex justify-content-end">
									<a href="index-rental.html" class="btn btn-outline-secondary">Back to List</a>
								</div>
							</div>
						`;
						return;
					}

					// Set rental ID
					form.querySelector('#rentalId').value = rental.id;

					// User Information
					form.querySelector('#userId').value = rental.user_id ?? '';
					form.querySelector('#userName').value = rental.user_name ?? '';
					form.querySelector('#userEmail').value = rental.user_email ?? '';

					// Load book items for current rental (use rental.items)
					if (Array.isArray(rental.items) && rental.items.length > 0) {
						rentalBooks = rental.items.map(it => ({
							// map item -> book view
							id: it.book_id ?? it.bookId ?? null,
							title: it.book_title ?? it.title ?? '',
							isbn: it.book_isbn ?? it.isbn ?? '',
							author: it.book_author ?? it.author ?? '',
							cover_image: it.cover_image ?? null,
							quantity: it.quantity ?? 1,
							start_date: it.start_date ?? it.rental_date ?? null,
							end_date: it.end_date ?? it.end_date ?? null,
							rental_id: rental.id,
							rental_item_id: it.id, // item id
						}));
						renderBooksList();
					} else {
						renderBooksList();
					}

					// Rental Details
					form.querySelector('#rentalDate').value = formatDateTimeDisplay(rental.rental_date);
					form.querySelector('#dueDate').value = formatDateTimeLocal(rental.due_date);
					form.querySelector('#returnDate').value = formatDateTimeLocal(rental.return_date);
					form.querySelector('#status').value = rental.status ?? 'active';
					form.querySelector('#notes').value = rental.notes ?? '';
				})
				.catch((error) => { 
					form.innerHTML = `<div class="alert alert-danger mb-0">${error.message}</div>`; 
				});

			form.addEventListener('submit', async (event) => {
				event.preventDefault();

				// If items were added/removed, editing items is not supported in this form.
				const newBooks = rentalBooks.filter(b => !b.rental_item_id && !b.rental_id);
				const deletedBooks = rentalBooks.filter(b => b._delete || (b.rental_item_id && b._delete));
				if (newBooks.length > 0 || deletedBooks.length > 0) {
					alert('Modifying items in this rental (adding/removing books) is not supported in this form. Please use the dedicated items management interface.');
					return;
				}

				// Proceed to update header only
				const btn = form.querySelector('button[type="submit"]');
				const original = btn.textContent;
				btn.disabled = true; 
				btn.textContent = 'Saving...';
				
				try {
					const rentalId = Number(form.querySelector('#rentalId').value);
					const userIdNum = Number(form.querySelector('#userId').value);
					const notes = form.querySelector('#notes').value.trim();
					const status = form.querySelector('#status').value;
					const dueDate = form.querySelector('#dueDate').value;
					const returnDate = form.querySelector('#returnDate').value;

					const payload = {
						id: rentalId,
						user_id: userIdNum,
						notes: notes,
						status: status,
					};
					if (dueDate) payload.due_date = dueDate.replace('T', ' ') + ':00';
					if (returnDate) payload.return_date = returnDate.replace('T', ' ') + ':00';

					const res = await fetch('api/rentals.php', {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload),
					});
					const data = await res.json();
					if (!res.ok || data?.error) throw new Error(data?.error || 'Unable to update rental.');

					window.location.href = 'index-rental.html?updated=1';
				} catch (err) {
					alert(err.message || 'An unexpected error occurred.');
				} finally {
					btn.disabled = false; 
					btn.textContent = original;
				}
			});
		})();
	</script>
</body>
</html>
